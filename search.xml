<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Javaå¸¸ç”¨è¯Šæ–­å·¥å…·</title>
      <link href="/2020/04/16/Java%E5%B8%B8%E7%94%A8%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/"/>
      <url>/2020/04/16/Java%E5%B8%B8%E7%94%A8%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<p>é¢ï¼Œå’‹è¯´å‘¢ï¼Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œå¯ä»¥æŠŠä¸€äº›ä¸œè¥¿ç»™ä¸²èµ·æ¥ï¼Œ</p><a id="more"></a><h1 id="Javaç›¸å…³å‘½ä»¤"><a href="#Javaç›¸å…³å‘½ä»¤" class="headerlink" title="Javaç›¸å…³å‘½ä»¤"></a>Javaç›¸å…³å‘½ä»¤</h1><p>å¸¸ç”¨çš„å‘½ä»¤ï¼š</p><h2 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h2><p>é€šå¸¸æ¥è¯´ï¼Œå¦‚æœå‡ºç°ç¨‹åºå¡æ­»äº†ï¼ˆæ¯”å¦‚restart tomcatçš„æ—¶å€™ï¼‰ï¼Œä¸çŸ¥é“å¡å“ªå„¿äº†ï¼Œå’‹åŠå‘¢ï¼Œç”¨jstackçœ‹ä¸€ä¸‹å“ªä¸ªçº¿ç¨‹åœ¨å¹²äº‹</p><pre class="line-numbers language-shell"><code class="language-shell">  jstack -l $(pid)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h2><p>è¿™ä¸ªè²Œä¼¼å°±æ˜¯ç”¨æ¥çœ‹gcçš„ã€‚ã€‚å¹³æ—¶ä¸€èˆ¬å…¶ä»–çš„ä¹Ÿéƒ½ç”¨ä¸ä¸Šå•Š</p><pre class="line-numbers language-shell"><code class="language-shell">  jstat [-å‘½ä»¤é€‰é¡¹] [vmid] [é—´éš”æ—¶é—´/æ¯«ç§’] [æŸ¥è¯¢æ¬¡æ•°]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h2><p>åŸºæœ¬ä¸Šï¼Œç”¨åˆ°äº†jmapå°±æ˜¯å†…å­˜æ³„æ¼äº†<br>å¸¸ç”¨å‘½ä»¤</p><pre class="line-numbers language-shell"><code class="language-shell">  jmap -histo $(pid)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="jcmd"><a href="#jcmd" class="headerlink" title="jcmd"></a>jcmd</h2><p>  å‘é€è¯Šæ–­å‘½ä»¤ï¼Œä¼¼ä¹å•¥éƒ½èƒ½å¹²ï¼Œå‘é€helpå‘½ä»¤ï¼Œå¯ä»¥åŸºæœ¬çœ‹ä¸€äº›èƒ½å¹²çš„äº‹</p><pre class="line-numbers language-shell"><code class="language-shell">jcmd $(pid) help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="jmc"><a href="#jmc" class="headerlink" title="jmc"></a>jmc</h2><p>jmcå…¶å®å°±æœ‰ç‚¹æ„æ€ï¼Œè¯´ç™½äº†æ˜¯ä¸€ä¸ªç‰¹æ€§ï¼Œé…åˆå’Œjfrä½¿ç”¨ï¼Œ</p><h1 id="ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤"><a href="#ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤" class="headerlink" title="ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤"></a>ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤</h1><h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>çœ‹å†…å­˜çš„å¸¸ç”¨å‘½ä»¤ï¼Œçœ‹ä¸€ä¸‹æ€»å†…å­˜ã€å·²ç”¨å†…å­˜ã€ç©ºé—²å†…å­˜ã€å…±äº«å†…å­˜ã€buff/cacheå†…å­˜å’Œå¯ç”¨å†…å­˜çš„å¤§å°<br>ä»¥åŠswapåˆ†åŒºçš„å¤§å°ï¼ˆå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘çš„æœºå™¨ä¸Šswapåˆ†åŒºå¤§å°ä¸º0ï¼Œå°±æ˜¯è¯´ä¸ä¼šäº§ç”Ÿswapï¼Œç›´æ¥OOMï¼Œé¿å…äº§ç”Ÿswapæœºåˆ¶å¸¦æ¥çš„IOç“¶é¢ˆé—®é¢˜ï¼‰</p><pre class="line-numbers language-shell"><code class="language-shell">[kevin@ky1 ~]$ free -h              total        used        free      shared  buff/cache   availableMem:          3.7Gi       823Mi       360Mi       0.0Ki       2.5Gi       2.6GiSwap:            0B          0B          0B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><p>topå‘½ä»¤ï¼Œé›†å¤§æˆï¼Œä¸å±•å¼€è¯´äº†</p><pre class="line-numbers language-shell"><code class="language-shell">[kevin@ky1 ~]$ toptop - 23:16:12 up 12 days,  4:16,  1 user,  load average: 0.13, 0.04, 0.01Tasks: 105 total,   1 running, 104 sleeping,   0 stopped,   0 zombie%Cpu(s):  0.0 us,  3.2 sy,  0.0 ni, 96.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 stMiB Mem :   3780.8 total,    360.5 free,    823.7 used,   2596.6 buff/cacheMiB Swap:      0.0 total,      0.0 free,      0.0 used.   2691.2 avail Mem  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND 3084 root      10 -10  180812  37704  15780 S   6.7   1.0 219:32.13 AliYunDun    1 root      20   0  178540  10912   8004 S   0.0   0.3   0:12.98 systemd    2 root      20   0       0      0      0 S   0.0   0.0   0:00.26 kthreadd    3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp    4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="pmap"><a href="#pmap" class="headerlink" title="pmap"></a>pmap</h2><p>åˆšå¥½åœ¨ç½‘ä¸ŠæŸ¥åˆ°ä¸€ä¸ªç‰¹åˆ«å¥½çš„ä¾‹å­è¿™é‡Œå…¶å®åˆšå¥½é‡åˆ°ä¸€ä¸ªç‰¹åˆ«å¥½çš„ä¾‹å­<br>å¼€å§‹ç”¨NMTå’Œpmapæ¥è¿›è¡Œåˆ†æå†…å­˜çš„åˆ†å¸ƒï¼Œè¿™é‡Œå¯¹äºjvmçš„å†…å­˜ï¼Œå’ŒçœŸæ­£ä¸€ä¸ªè¿›ç¨‹é”å¯¹åº”çš„å®é™…å†…å­˜æ˜¯å¦‚ä½•åˆ†å¸ƒçš„ï¼Œæœ‰ä¸€ä¸ªç‰¹åˆ«æ·±å…¥ç›´è§‚çš„ç†è§£</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªpmapçš„ä¸€ä¸ªåŸºç¡€è¾“å‡ºï¼Œï¼ˆç‰ˆæœ¬ä¸åŒå¯èƒ½è¾“å‡ºä¸ä¸€æ ·ï¼‰</p><pre class="line-numbers language-shell"><code class="language-shell">START               SIZE     RSS     PSS   DIRTY          SWAP PERM MAPPING00000000d54aa000  92824K  92824K  92824K  92824K       0K  rw-p   [anon]00000000daf50000  174784K 174784K 174784K 174784K       0K  rw-p   [anon]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> ç„¶åå¯¹æ¯”ä¸€ä¸‹ NMT çš„è¾“å‡º</p><pre class="line-numbers language-shell"><code class="language-shell">jcmd 14179 VM.native_memory detail<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell"><code class="language-shell"> 14179: Native Memory Tracking: Total: reserved=653853KB, committed=439409KB -                 Java Heap (reserved=262144KB, committed=262144KB)                             (mmap: reserved=262144KB, committed=262144KB) -                     Class (reserved=82517KB, committed=81725KB)                             (classes #17828)                             (malloc=1317KB #26910)                             (mmap: reserved=81200KB, committed=80408KB) -                    Thread (reserved=20559KB, committed=20559KB)                             (thread #58)                             (stack: reserved=20388KB, committed=20388KB)                             (malloc=102KB #292)                             (arena=69KB #114) -                      Code (reserved=255309KB, committed=41657KB)                             (malloc=5709KB #11730)                             (mmap: reserved=249600KB, committed=35948KB) -                        GC (reserved=1658KB, committed=1658KB)                             (malloc=798KB #676)                             (mmap: reserved=860KB, committed=860KB) -                  Compiler (reserved=130KB, committed=130KB)                             (malloc=31KB #357)                             (arena=99KB #3) -                  Internal (reserved=5039KB, committed=5039KB)                             (malloc=5007KB #20850)                             (mmap: reserved=32KB, committed=32KB) -                    Symbol (reserved=18402KB, committed=18402KB)                             (malloc=14972KB #221052)                             (arena=3430KB #1) -    Native Memory Tracking (reserved=2269KB, committed=2269KB)                             (malloc=53KB #1597)                             (tracking overhead=2216KB) -               Arena Chunk (reserved=187KB, committed=187KB)                             (malloc=187KB) -                   Unknown (reserved=5640KB, committed=5640KB)                             (mmap: reserved=5640KB, committed=5640KB)  . . . Virtual memory map: [0xceb00000 - 0xcec00000] reserved 1024KB for Class from [0xced00000 - 0xcee00000] reserved 1024KB for Class from . . . [0xcf85e000 - 0xcf8af000] reserved and committed 324KB for Thread Stack from [0xd4eaf000 - 0xd4f00000] reserved and committed 324KB for Thread Stack from     [0xf687866e] Thread::record_stack_base_and_size()+0x1be     [0xf68818bf] JavaThread::run()+0x2f     [0xf67541f9] java_start(Thread*)+0x119     [0xf7606395] start_thread+0xd5 //******************** æ³¨æ„è¿™é‡Œ [0xd5a00000 - 0xe5a00000] reserved 262144KB for Java Heap from //******************** æ³¨æ„è¿™é‡Œ . . . [0xe5e00000 - 0xf4e00000] reserved 245760KB for Code from [0xf737f000 - 0xf7400000] reserved 516KB for GC from [0xf745d000 - 0xf747d000] reserved 128KB for Unknown from [0xf7700000 - 0xf7751000] reserved and committed 324KB for Thread Stack from [0xf7762000 - 0xf776a000] reserved and committed 32KB for Internal from<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­æœ‰ä¸€è¡Œ</p><pre class="line-numbers language-shell"><code class="language-shell">[0xd5a00000 - 0xe5a00000] reserved 262144KB for Java Heap from<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> æ‰€åœ¨çš„é‚£ä¸€è¡Œï¼Œè¡¨ç¤ºäº†javaçš„å †å†…å­˜ä»0xd5a00000å¼€å§‹<br>è¾…åŠ©ä¸Šåœ¨linuxå½“ä¸­ï¼Œè¿›ç¨‹çš„å†…å­˜åˆ†å¸ƒå›¾ï¼Œæ¯ä¸€å—å†…å­˜æ˜¯å¦‚ä½•åˆ†é…çš„å°±ä¸€ç›®äº†ç„¶äº†</p><p><img src="/images/java-tools/pmap.png" alt="pmap"><br>ç”¨äºå¯¹æ¯”ï¼Œé™„ä¸Šï¼Œè™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†å¸ƒå›¾ï¼Œ<br><img src="/images/java-tools/memory2.png" alt="memory"><br><img src="/images/java-tools/memory.png" alt="memory"></p><h2 id="vmstat"><a href="#vmstat" class="headerlink" title="vmstat"></a>vmstat</h2><h2 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h2>]]></content>
      
      
      
        <tags>
            
            <tag> -Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤šç‰ˆæœ¬jdkå¸è½½</title>
      <link href="/2020/04/14/%E5%A4%9A%E7%89%88%E6%9C%ACjdk%E5%8D%B8%E8%BD%BD/"/>
      <url>/2020/04/14/%E5%A4%9A%E7%89%88%E6%9C%ACjdk%E5%8D%B8%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨æœºå™¨ä¸Šæœ‰è‡ªå·±å®‰è£…jdkï¼Œåé¢å› ä¸ºæ˜¯centosï¼Œå› ä¸ºå¼€å‘å·¥å…·åŒ…çš„å…³ç³»æ‰€ä»¥åˆå®‰è£…äº†open-jdkï¼Œå¯¼è‡´äº†æ˜¯è¯´åŒæ—¶å­˜åœ¨å¤šä¸ªç‰ˆæœ¬jdkçš„é—®é¢˜ï¼Œ</p><a id="more"></a><p>åœ¨ä½¿ç”¨jmapçš„æ—¶å€™æŠ¥äº†å¦‚ä¸‹é”™è¯¯ï¼ˆä¿¡æ¯æ˜¯ç½‘ä¸ŠæŠ„çš„ï¼Œå¤§è‡´æ˜¯è¿™ä¸ªæ„æ€ï¼‰</p><pre class="line-numbers language-Java"><code class="language-Java">Exception in thread "main" sun.jvm.hotspot.runtime.VMVersionMismatchException: Supported versions are 1.5.0, 1.5.0_xx. Target VM is 20.6-b01<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰€ä»¥éœ€è¦åˆ æ‰æœ¬æœºçš„open-sdkï¼Œç»Ÿä¸€æˆoracle-jdkï¼Œå¦‚æœjava -versionå‡ºç°ä»¥ä¸‹æç¤ºï¼Œè¯´æ˜é»˜è®¤ä½¿ç”¨çš„æ˜¯open-jdk</p><pre class="line-numbers language-Java"><code class="language-Java">java version "1.8.0"OpenJDK  Runtime Environment (build 1.8.0-b09)OpenJDK 64-Bit Server VM (build 1.8.0-b09, mixed mode)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æœ€å¥½è¿˜æ˜¯å…ˆå¸è½½æ‰openjdk,åœ¨å®‰è£…Oracleçš„jdk,</p><p>###<br>1.ç¡®å®šJDKçš„ç‰ˆæœ¬ï¼š<br>rpm -qa | grep jdk</p><p>å¯èƒ½çš„ç»“æœæ˜¯ï¼š</p><p>libgcj-4.1.2-42.el5<br>java-1.4.2-gcj-compat-1.4.2.0-40jpp.115</p><p>###<br>2.ç„¶åå¸è½½ï¼š</p><pre class="line-numbers language-Java"><code class="language-Java">yum -y remove java-1.4.2-gcj-compat-1.4.2.0-40jpp.115<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¸è½½å®Œæˆä»¥åï¼Œå¯ä»¥ç”¨whereis javaæŸ¥çœ‹javaçš„è·¯å¾„ï¼Œ</p><pre class="line-numbers language-Java"><code class="language-Java">java: /opt/java/jdk1.8.0_141/bin/java /opt/java/jdk1.8.0_141/jre/bin/java<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ—¶å€™å¦‚æœç›´æ¥ç”¨javaï¼Œå¯èƒ½ä¼šæŠ¥é”™è¯´ â€œ/usr/bin/java not foundâ€<br>é€€å‡ºç»ˆç«¯ï¼Œå¹¶ä¸”é‡æ–°æ‰“å¼€ä¸€ä¸ªç»ˆç«¯å³å¯</p>]]></content>
      
      
      
        <tags>
            
            <tag> åŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Difference Between Redis And Memcache</title>
      <link href="/2020/04/08/Difference-Between-Redis-And-Memcache/"/>
      <url>/2020/04/08/Difference-Between-Redis-And-Memcache/</url>
      
        <content type="html"><![CDATA[<p>è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹Rediså’ŒMemcacheçš„ä¸€äº›å¼‚åŒ</p><a id="more"></a><h1 id="Redis-amp-Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´"><a href="#Redis-amp-Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´" class="headerlink" title="Redis &amp; Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´"></a>Redis &amp; Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´</h1><ol><li>æ“ä½œä¸Š<br>Redisæ”¯æŒæœåŠ¡ç«¯çš„æ•°æ®æ“ä½œï¼Œï¼ˆæ¯”å¦‚incrï¼‰ï¼Œä½†æ˜¯Memcacheä¸è¡Œï¼Œéœ€è¦å°†å€¼ä»æœåŠ¡å™¨ä¸Šå–ä¸‹æ¥ï¼Œè¿ç®—ï¼Œä¹‹åå†å­˜å›Memcache</li><li>å†…å­˜ä½¿ç”¨ç‡ä¸Š<br>Memcacheçš„å†…å­˜ä½¿ç”¨ç‡æ¯”Redisæ›´ä½ã€‚ï¼ˆå’Œå†…å­˜åˆ†é…ç­–ç•¥ï¼Œå’Œæ•°æ®ç»“æ„æœ‰å…³ï¼‰</li><li>cpuä½¿ç”¨ä¸Š<br>Redisä»…æ”¯æŒå•æ ¸cpuï¼Œä½†æ˜¯Memcacheæ”¯æŒå¤šæ ¸cpu</li></ol><h1 id="å†è¯¦ç»†ç‚¹"><a href="#å†è¯¦ç»†ç‚¹" class="headerlink" title="å†è¯¦ç»†ç‚¹"></a>å†è¯¦ç»†ç‚¹</h1><h2 id="1-Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„"><a href="#1-Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„" class="headerlink" title="1. Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„"></a>1. Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„</h2><ul><li>string</li><li>hash</li><li>list</li><li>set</li><li>sorted set<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/RedisDataStructure.png" alt="RedisDataStructure"></li></ul><h2 id="2-å†…å­˜ç®¡ç†æœºåˆ¶"><a href="#2-å†…å­˜ç®¡ç†æœºåˆ¶" class="headerlink" title="2. å†…å­˜ç®¡ç†æœºåˆ¶"></a>2. å†…å­˜ç®¡ç†æœºåˆ¶</h2><p>æ€§èƒ½ï¼š<br>åœ¨redisä¸­ï¼Œå…è®¸å­˜å‚¨çš„å†…å®¹ï¼Œæ¯”å®é™…çš„ç‰©ç†å†…å­˜è¦æ›´å¤§ï¼Œå½“ç‰©ç†å†…å­˜ç”¨å®Œä¹‹åï¼Œå°±ä¼šä½¿ç”¨swapåˆ†åŒºã€‚swapæ“ä½œæ˜æ˜¾ä¼šé€ æˆioé˜»å¡<a href="https://redis.io/topics/virtual-memory" target="_blank" rel="noopener">å…³äºVirtualMachine</a><br>è€Œmemcacheä¸è¡Œï¼Œä»…æ”¯æŒç‰©ç†å†…å­˜æ“ä½œï¼Œæ‰€ä»¥ï¼Œä»çº¯é€Ÿåº¦ä¸Šæ¥è¯´ï¼Œmemcacheçš„æ€§èƒ½è¦æ¯”redisè¦æ›´å¥½ã€‚<br>æœºåˆ¶:<br>memcacheçš„å†…å­˜åˆ†å¸ƒå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶å®ç±»ä¼¼äºlinuxæ–‡ä»¶ç³»ç»Ÿï¼Œå­˜åœ¨ä¸€å®šçš„å†…å­˜æµªè´¹<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/MemcacheMemoryScheme.png" alt="MemcacheMemoryScheme"></p><p>è€Œå…³äºredisçš„å†…å­˜åˆ†é…åˆ™æ˜¯æ ¹æ®åŸºç¡€ç»“æ„æ¥å®šçš„ï¼Œæµªè´¹è¾ƒå°‘ï¼Œä¸è¿‡è¿™æ ·çš„åˆ†é…å®¹æ˜“å‡ºç°å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œå®˜æ–¹æ–‡æ¡£èµ„æºåˆ™è¯¦ç»†å¾—å¤šï¼Œæˆ‘è¿™é‡Œç›´æ¥ç²˜ä¸€ä¸‹å¥½äº†ï¼Œä¸€å…±4ç‚¹</p><ul><li>å½“keyè¢«åˆ é™¤çš„æ—¶å€™ï¼Œredisä¸ä¼šç«‹åˆ»é‡Šæ”¾å†…å­˜ï¼Œå¦‚æœä½¿ç”¨äº†5Gå†…å­˜ï¼Œç„¶åé‡Šæ”¾äº†2Gï¼Œé‚£ä¹ˆå®é™…ä¸Šçš„å ç”¨ä¾ç„¶ä¼šæ˜¯5G</li><li>åŸºäºç¬¬ä¸€ç‚¹ï¼Œéœ€è¦é¢„è§åˆ°å®é™…çš„rediså ç”¨ï¼Œå¦‚æœé«˜å³°æœŸå¯èƒ½ä½¿ç”¨åˆ°10Gï¼Œé‚£ä¹ˆå°±éœ€è¦æå‰é¢„å¤‡10Gçš„å†…å­˜ï¼ˆè²Œä¼¼æ˜¯åºŸè¯ï¼‰</li><li>å¦‚æœç”³è¯·äº†5Gä¹‹åï¼Œé‡Šæ”¾äº†2Gï¼Œä¹‹ååˆéœ€è¦ä½¿ç”¨å†…å­˜ï¼Œé‚£ä¹ˆredisä¼šåŸºæœ¬ä¸Šä¼šé‡å¤ä½¿ç”¨è¿™2Gçš„èµ„æºï¼ˆè²Œä¼¼ä¹Ÿæ˜¯åºŸè¯ï¼‰</li><li>è¿™æ ·çš„è¯ï¼Œç¢ç‰‡ç‡çš„å½“ å³°å€¼/å¹³æ—¶å€¼ æ¯”ç‡è¾ƒé«˜çš„æ—¶å€™ï¼Œç¢ç‰‡ç‡ä¼šæ¯”è¾ƒé«˜<br>å‚è€ƒéƒ¨åˆ†ï¼š<a href="https://redis.io/topics/memory-optimization" target="_blank" rel="noopener">memory-optimization</a></li></ul><h2 id="3-æ•°æ®æŒä¹…åŒ–"><a href="#3-æ•°æ®æŒä¹…åŒ–" class="headerlink" title="3. æ•°æ®æŒä¹…åŒ–"></a>3. æ•°æ®æŒä¹…åŒ–</h2><p>memcacheç®€å•ç²—æš´ï¼Œç›´æ¥ä¸æ”¯æŒ<br>redisæ”¯æŒï¼Œä¸¤ç§æ¨¡å¼ï¼šrdbå¿«ç…§&amp;AOFæ–‡ä»¶</p><h2 id="4-é›†ç¾¤åŒ–ç®¡ç†"><a href="#4-é›†ç¾¤åŒ–ç®¡ç†" class="headerlink" title="4. é›†ç¾¤åŒ–ç®¡ç†"></a>4. é›†ç¾¤åŒ–ç®¡ç†</h2><ul><li>memcacheæœ¬èº«å¯¹äºé›†ç¾¤åŒ–æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå°±æ˜¯è¯´ï¼Œå¯ä»¥å¯åŠ¨å¤šä¸ªmemcacheèŠ‚ç‚¹ï¼Œå®Œäº†åœ¨å®¢æˆ·ç«¯é€šè¿‡ç®—æ³•ï¼Œå°†æ•°æ®hashåˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡clientç«¯çš„å¤„ç†æ¥åšä¸€ä¸ªé›†ç¾¤<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/memcacheCluster.png" alt="MemcacheCluster"></li><li>redisçš„é›†ç¾¤åˆ™å¯ä»¥ç›´æ¥åœ¨æœåŠ¡ç«¯åšå¤„ç†<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/redisCluster.png" alt="MemcacheCluster"></li></ul>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> In-Memory Data Storage Systems </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019, New Beginning</title>
      <link href="/2019/01/01/hello-world/"/>
      <url>/2019/01/01/hello-world/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/background.jpeg" alt><br>æ²¡å•¥å¥½è¯´çš„ï¼Œç»™æ‚¨åŠˆä¸ªå‰å§</p><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è‹¦å‘½ç®¡å®¶ä¹‹å·§è§£è‰è“é£æ³¢</title>
      <link href="/2017/02/19/Stawberry/"/>
      <url>/2017/02/19/Stawberry/</url>
      
        <content type="html"><![CDATA[<p>é˜¿å“²æ˜¯æ‘ä¸œè¾¹çš„å¤§æˆ·ï¼Œä»–æœ‰ä¸€ä¸ªç‰¹åˆ«å‰å®³çš„ç®¡å®¶ï¼Œèƒ½è¯´ä¼šé“ï¼Œæ™ºå•†è¶…äººï¼Œè¯´åˆ°è‰è“é£æ³¢â€¦</p><a id="more"></a><h1 id="äº‹èµ·"><a href="#äº‹èµ·" class="headerlink" title="äº‹èµ·"></a>äº‹èµ·</h1><p>è€çˆ·å¹³æ—¥æ²¡å•¥çˆ±å¥½ï¼Œå¹´å‰ä¸‹è‹æ­æ—¶å€™ç¢°å·§å°äº†ä¸€æ¬¡è‰è“ï¼Œè‡³æ­¤æ¯æ—¥å¿µå¿µä¸å¿˜ï¼Œæ‹›æ¥ç®¡å®¶â€¦</p><h2 id="åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†"><a href="#åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†" class="headerlink" title="åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†"></a>åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†</h2><p>  å˜´é¦‹ä¹Ÿæœ‰è®²ç©¶ï¼Œä¸æ˜¯èƒ¡åƒæµ·å–ï¼Œå’±ä»¬è¦æŒç»­æ€§å‘å±•â€¦<br>  è‰è“è¿™ç‰©ä»¶ï¼Œè¿™å¹´ä»£ä¹Ÿæ²¡å†°ç®±ä»€ä¹ˆçš„ï¼Œæœ€æ–°é²œçš„å°±æ˜¯æ¯æ—¥é‡‡æ‘˜ï¼Œè€çˆ·åšçš„é•¿è¿œæ‰“ç®—ï¼Œæ¯æ—¥ä¸€é†’å°±å¯¹è‰è“å¿ƒå¿ƒå¿µå¿µï¼Œæ‰€ä»¥å•Šï¼Œå°±æƒ³è¶Šæ—©è¶Šå¥½ï¼Œæ™šæ¥ä¸€ç‚¹ä¹Ÿæ²¡å…³ç³»ï¼Œä½†æ˜¯å¿…é¡»æ˜¯ä»Šå¤©æ‘˜çš„æ‰è¡Œï¼Œä½†æ˜¯ä¸€å¤©éƒ½æ²¡åƒåˆ°å¥½è‰è“ï¼Œæˆ‘å¯æ˜¯è¦å‘é£™å“¦ï¼<br>  è¿˜æœ‰ï¼Œè¿™è‰è“è™½å¥½ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½è´ªæ¯å“¦â€¦å•Šå‘¸ï¼Œä¸èƒ½å¤šåƒï¼Œæ¯æ—¥ä¸€è¢‹æ˜¯ä¸ºæœ€å¥½ï¼Œä¹‹åæ¥çš„ï¼Œå°±æŠŠä»–ä»¬é€€æ‰å§ï¼</p><h2 id="è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ"><a href="#è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ" class="headerlink" title="è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ"></a>è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ</h2><p>å¯¹äºè€çˆ·çš„æƒ³æ³•ï¼Œç®¡å®¶è‡ªç„¶æ˜¯æ‘¸å¾—é€å½»ï¼Œç¨ä½œç›˜ç®—ï¼Œå°±çŸ¥é“è€çˆ·æƒ³çš„æ˜¯å•¥</p><ol><li>æ¯å¤©éƒ½éœ€è¦æ¶ˆè€—ä¸€æ‰¹è‰è“(å°½æœ€å¤§åŠªåŠ›)</li><li>æ¯å¤©ä»…åƒä¸€æ‰¹è‰è“</li><li>åªåƒå½“æ—¥æœ€æ–°é²œçš„ã€è´¨é‡è¿‡å…³çš„è‰è“ï¼Œè‡³äºæ˜¯è°æä¾›çš„å¹¶ä¸é‡è¦</li><li>å¦‚æœæœ‰å¤šä½™çš„æˆ–è€…ä¸åˆæ ¼çš„è‰è“ï¼Œåˆ™éœ€è¦æŠŠä»–ä»¬å¤„ç†æ‰(é€€è´§)</li></ol><h2 id="å¬é›†å•†å®¶"><a href="#å¬é›†å•†å®¶" class="headerlink" title="å¬é›†å•†å®¶"></a>å¬é›†å•†å®¶</h2><p>ä»»åŠ¡å©å’ä¸‹å»ï¼Œè®©ç®¡å®¶ä¸€æ‰‹æ“åŠï¼Œè€æ¿æå‡ºäº†éœ€æ±‚ï¼Œé‚£ç®¡å®¶å°±åªèƒ½è·‘è·‘è…¿äº†ï½ è¦æ‹¿åˆ°è‰è“ï¼Œé‚£å¾—é¦–å…ˆè”ç³»ä¸€ä¸‹è‰è“ä¾›åº”å•†æ˜¯ä¸ªä»€ä¹ˆæƒ…å†µ</p><p>å‡ æ—¥ä¹‹åï¼Œå¾ˆå¿«å°±æœ‰äº†æ¶ˆæ¯ï¼Œè¿™å‡ å®¶ä¾›åº”å•†ï¼Œå› ä¸ºè‰è“å±äºç°æ‘˜ï¼Œæ¯æ—¥çš„æƒ…å†µéƒ½ä¸ä¸€æ ·ï¼Œä¾›åº”å•†æ¯å¤©é€æ¥éƒ½è´§ç‰©è´¨é‡ä¹Ÿéƒ½å‚å·®ä¸é½ï¼Œéœ€è¦ç®¡å®¶ä¸€ä¸€éªŒè¿‡<br>å¦‚æœè´§ç‰©è´¨é‡ä¸è¡Œï¼Œé‚£ä¹ˆå°±åªèƒ½é€€è´§å•¦ï¼Œåˆæˆ–è€…æˆ‘ä»¬è€çˆ·å½“æ—¥åªèƒ½åƒè¿‡è‰è“äº†ï¼Œé‚£ä¹ˆæŠ±æ­‰ï¼Œä½ è¿™æ‰¹è´§æˆ‘åªèƒ½é€€å•¦ï¼Œè¦æ˜¯ä½ æ¥çš„æ—¶å€™ï¼Œç®¡å®¶è¿˜åœ¨éªŒä¸Šå®¶çš„è´§ï¼Œé‚£ä½ å¯ä»¥ç¢°ç¢°è¿æ°”ï¼Œä¸‡ä¸€ä¸Šå®¶çš„è´§ç‰©ä¸è¿‡å…³å‘¢ï¼Œæ˜¯å§ï½</p><p>ç®€è€Œè¨€ä¹‹ï¼Œå¸‚åœºç«äº‰çœŸæ˜¯æ¿€çƒˆå‘€ï¼</p><p>é‚£ä¹ˆæç‚¼ä¸€ä¸‹ï¼š</p><ol><li>ä¸ä¿è¯æ¯æ—¥éƒ½æœ‰è´§ç‰©</li><li>ä¸ä¿è¯è´§ç‰©çš„è´¨é‡</li><li>ä¸ä¿è¯åˆ°è´§æ—¶é—´</li><li>æ¥å—é€€è´§</li><li>ä¾›åº”å•†åœ¨è´§ç‰©é€åˆ°ä¹‹å‰ï¼Œå¹¶ä¸çŸ¥æ™“è€çˆ·ä»Šæ—¥æ˜¯å¦å·²ç»äº«ç”¨äº†è‰è“</li></ol><p>å—¯ï¼Œä»»æ€§çš„ä¾›åº”å•†æä¾›çš„æœåŠ¡è¿˜çœŸæ˜¯ä¸æ€ä¹ˆå¯é å•Šï¼Œä½†æ˜¯è¿™æ€»éš¾ä¸ä½èªæ˜çš„ç®¡å®¶ï¼Œå’‹ä¸€çœ‹ï¼Œè™½ç„¶æ¯ä¸€å®¶è´§ç‰©æä¾›å•†å¹¶ä¸èƒ½æä¾›å®Œå…¨å¯é çš„æœåŠ¡ï¼Œä½†æ˜¯æˆ‘å¤šå–Šå‡ å®¶ä¸€èµ·ä¸Šï¼Œé‚£ä¹ˆè€çˆ·çš„éœ€æ±‚è¿˜æ˜¯å¯ä»¥å°½é‡æ»¡è¶³çš„å˜›ï¼Œæƒ³åˆ°è¿™é‡Œï¼Œç®¡å®¶å°±è¢«è‡ªå·±çš„èªæ˜æ‰æ™ºé”æŠ˜æœäº†ï¼Œå¿ƒé‡Œè¿˜æœ‰ç‚¹å°æ¿€åŠ¨å‘¢ (à²¡Ï‰à²¡)hiahiahia</p><p>å¿ƒä¸­ä¸€é˜µç›˜ç®—ä¹‹åï¼Œé€šçŸ¥ä¾›åº”å•†ä»¬å¬é›†åˆ°é™¢ä¸­å¼€äº†ä¸€æ¬¡é›†ä½“ä¼šè®®â€¦.</p><h1 id="ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š"><a href="#ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š" class="headerlink" title="ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š"></a>ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š</h1><p>ä¼—å•†å®¶ï¼Œä»Šæ—¥å°†å¤§å®¶å¬é›†åˆ°æ­¤ï¼Œæ˜¯ä¸ºäº†é€šçŸ¥å„å•†å®¶ä¹‹åå’±ä»¬çš„ç»Ÿä¸€ä¾›è´§æ–¹å¼ï¼Œä¸€æ–¹é¢å°½é‡ä¿è¯è€çˆ·çš„è¦æ±‚ï¼Œä¸€æ–¹é¢å‘¢ï¼Œä¹Ÿæ˜¯å’Œå¤§å®¶æ‰“ä¸ªæ‹›å‘¼ï¼Œå’±ä»¬ä»¥åå°±æŒ‰ç…§è¿™ä¸ªæ³•å­æ¥ï¼Œäº’é€šæœ‰æ— å˜›</p><p>ä¹‹åæ¯æ—¥ï¼Œè‹¥å„ä½è´§ç‰©åˆ°åï¼Œå¯å°†è´§ç‰©å…ˆç½®æ”¾äºé™¢ä¸­ï¼Œç„¶åç”±çŸ¥æ™“æˆ‘ï¼Œå¾…æˆ‘æ¥å¯¹è´§ç‰©è¿›è¡ŒéªŒæ”¶ï¼ŒéªŒæ”¶é€šè¿‡ä¹‹åï¼Œå‘ä½ å‘æ”¾å½“æ—¥æ¬¾é¡¹ã€‚è‹¥é€šçŸ¥æˆ‘æ—¶ï¼Œæˆ‘å·²æ‰¾åˆ°ä¸€æ‰¹æ–°é²œçš„è´§ç‰©ï¼Œé‚£ä¹ˆä½ è´§çš„æ–°é²œç¨‹åº¦ä¸å¦‚ä¸Šå®¶ï¼Œè‡ªç„¶æ˜¯è¾“äº†ï¼Œé‚£ä¹ˆæˆ‘å°±æ— æ³•ç»™ä½ æ¬¾é¡¹ï¼Œåªèƒ½å°†è´§é€€è¿˜ç»™ä½ ã€‚è‹¥æˆ‘è¿˜åœ¨éªŒè´§ï¼Œé‚£ä½ å¯ä»¥å†ç­‰ç­‰ï¼Œè‹¥ä¹‹å‰çš„è´§ç‰©ä¸åˆæ ¼ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç­‰ç­‰ï¼Œè‹¥ä¸Šå®¶çš„è´§ç‰©ä¸ç¬¦åˆè€çˆ·çš„è¦æ±‚ï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥æ¥éªŒä½ çš„è´§å•¦ï½</p><p>å„å•†å®¶è§ç®¡å®¶æå‡ºå¦‚æ­¤å¦¥å–„çš„æ³¨æ„ï¼Œäº‹å°‘ï¼Œä¹Ÿä¸ç”¨å’Œåˆ«å®¶ä¼¤å’Œæ°”ï¼Œä¸€åˆ‡ä¹°å–å…¨å‡­æœ¬äº‹ï¼Œä¸€ä¸ªä¸€ä¸ªä¹Ÿæ‘©æ‹³æ“¦æŒï¼Œçº·çº·è¡¨ç¤ºèµåŒ</p><h1 id="å•æœºç‰ˆ"><a href="#å•æœºç‰ˆ" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h1><p>ä¸€æ®µæ—¶æ—¥ä¹‹åï¼Œè€çˆ·å¦‚æ„¿åƒä¸Šäº†æƒ³è¦çš„è‰è“ğŸ“ï¼Œç®¡å®¶ä¹Ÿå°†æ­¤æ–¹æ³•è®°å½•äº†ä¸‹æ¥ï¼Œä»¥ä¾¿æ”¹è¿›ä¸å­¦ä¹  :)</p><p>å•†å®¶p1ã€p2å±äºé›†åˆP<code>(Provider)</code>ï¼Œå•†å®¶æä¾›çš„æœåŠ¡éƒ½æ˜¯åŒè´¨çš„ï¼Œå¯ä»¥å½’ä¸ºä¸€ç±»ï¼Œåˆ†åˆ«ä¸º</p><ol><li>é€è´§ deliver</li><li>éªŒè´§ validate</li><li>é€€è´§ takeBack</li></ol><p>è€Œç®¡å®¶g<code>(governor)</code>çš„çŠ¶æ€åˆ†ä¸ºå‡ ç§</p><ol><li>å°šæœªéªŒè´§ available</li><li>æ­£åœ¨éªŒè´§ validating</li><li>éªŒè´§ç»“æŸ unavailable</li></ol><p>é‚£ä¹ˆå•†å®¶æ‰€æ‰§è¡Œçš„æ­¥éª¤å¯ä»¥ç”¨å¦‚ä¸‹ä¼ªä»£ç è¡¨ç¤ºï¼š</p><pre class="line-numbers language-Java"><code class="language-Java">public class ProviderDeliver {  public void dailyWork(Provider p, Governor g){}  p.deliver();  if (g.unavailable()) {    p.takeBack();    return ;  }  while (g.validating()) {    // simply wait  }  if (g.available()) {    p.validate();  } else {    p.takeBack();  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="åˆ†å¸ƒå¼ç‰ˆ"><a href="#åˆ†å¸ƒå¼ç‰ˆ" class="headerlink" title="åˆ†å¸ƒå¼ç‰ˆ"></a>åˆ†å¸ƒå¼ç‰ˆ</h1><p>å“å‘€ï¼Œè€çˆ·ä¸€é«˜å…´ï¼Œèµé‡‘ç»™å¾—ç‰¹åˆ«é«˜ï¼Œå„è·¯å•†å®¶æ¥è¸µè€Œè‡³ï¼Œç®¡å®¶è¦å¿™ä¸è¿‡æ¥äº†ï¼Œäºæ˜¯å©å’ä¸‹å»å‡ ä¸ªå®¶ä¸ï¼Œåˆ†åˆ«æ¥å¾…å•†æˆ·ï¼Œæ£€æŸ¥ä¾ç„¶ç”±ç®¡å®¶äº²è‡ªæ“ä½œï¼Œä½†å•†æˆ·æ— éœ€ç­‰å¾…ï¼Œä»…éœ€è¦å°†è´§ç‰©æ”¾åœ¨åºœä¸­ï¼Œé€€è´§ç”±å®¶ä¸å®Œæˆï¼Œè€Œå•†æˆ·ä¹Ÿä¸ç›´æ¥ä¸ç®¡å®¶æ¥è§¦ï¼Œç”±å®¶ä¸è´Ÿè´£å•†å®¶å’Œç®¡å®¶ä¹‹é—´çš„æ²Ÿé€šï¼Œç®¡å®¶é€šè¿‡åºœé‚¸ä¸­çš„æ——å¸œè¡¨ç¤ºè‡ªå·±ç›®å‰æ­£åœ¨éªŒè´§ã€ä¼‘æ¯ã€éªŒè´§å®Œæ¯•</p><p>é‚£ä¹ˆæ•´ä½“çš„æµç¨‹ä½œä¸€ä¸‹ç®€å•è½¬æ¢ï¼Œå¯¹å•†æˆ·æ¥è¯´ï¼Œæµç¨‹æ›´åŠ ç®€å•</p><pre class="line-numbers language-Java"><code class="language-Java">/** * * Created by kevin on 20/02/2017. */public class Strawberry {    static AtomicInteger errorCount = new AtomicInteger(0);    static AtomicInteger takeBackCount = new AtomicInteger(0);    static AtomicInteger consumedCount = new AtomicInteger(0);    static AtomicInteger acceptedCount = new AtomicInteger(0);    static Random r = new Random();    static class ProviderDeliver2 {        private Provider p;        ProviderDeliver2(String name) {            this.p = new Provider(name);        }        void dailyWork(int day) {            Merchandise m = p.deliver(); // è¿é€è´§ç‰©            Worker worker = Worker.of(this, day); // éšä¾¿æ‰¾ä¸ªå®¶ä¸ï¼Œå¹¶æŠŠè´§ç‰©äº¤ç»™ä»–            worker.process(m); //  å®¶ä¸æ¥å¤„ç†è´§ç‰©        }        void takeBack(Merchandise m) {            int res = m.getTime().incrementAndGet();            if (res == 1) {                takeBackCount.incrementAndGet();            } else if (res > 1) {                System.out.println("fail! operate " + res );                errorCount.incrementAndGet();            }        }    }    static class Worker {        private Governor g;        private ProviderDeliver2 pd2;        Worker(ProviderDeliver2 pd2, Governor g) {            this.pd2 = pd2;            this.g = g;        }        static Worker of(ProviderDeliver2 pd2, int day) {            return new Worker(pd2, Governor.getInstance(day));        }        void process(Merchandise m) {            g.validate(this, m);        }        void takeBack(Merchandise m) {            pd2.takeBack(m);        }    }    static class Governor {        private AtomicBoolean available = new AtomicBoolean(true);        private AtomicBoolean validating = new AtomicBoolean(false);        private Queue<Merchandise> queue = Queues.newConcurrentLinkedQueue();        private int date;        private static ConcurrentHashMap<Integer, Governor> MAP = new ConcurrentHashMap<>();        static Governor getInstance(int day) {            return MAP.computeIfAbsent(day, Governor::new);        }        boolean available() {            return available.get();        }        private Governor(int date) {            this.date = date;        }        void validate(Worker worker, Merchandise m) {            try {                if (!available()) {                    worker.takeBack(m);                    return;                }                this.addMerchandise(m);                if (!validating.compareAndSet(false, true)) {                    return;                }                if (!available()) {                    cleanAll(worker);                    return;                }                while (!queue.isEmpty()) {                    Merchandise item = queue.poll();                    if (available() && item.isGood()) {                        available.set(false);                        acceptedCount.incrementAndGet();                    } else {                        worker.takeBack(item);                    }                }                validating.set(false);            } finally {                consumedCount.incrementAndGet();            }        }        private void cleanAll(Worker worker) {            while (!queue.isEmpty()) {                Merchandise item = queue.poll();                worker.takeBack(item);            }        }        void addMerchandise(Merchandise m) {            queue.add(m);        }    }    public static class Provider {        private String name;        Provider(String name) {            this.name = name;        }        Merchandise deliver() {            return new Merchandise(this.name + System.nanoTime());        }    }    static class Merchandise {        private String name;        private AtomicInteger time = new AtomicInteger(0);        private long quality = r.nextInt(100);        AtomicInteger getTime() {            return time;        }        Merchandise(String name) {            this.name = name;        }        @Override        public boolean equals(Object o) {            if (this == o) return true;            if (o == null || getClass() != o.getClass()) return false;            Merchandise that = (Merchandise) o;            return name != null ? name.equals(that.name) : that.name == null;        }        @Override        public int hashCode() {            return name != null ? name.hashCode() : 0;        }        boolean isGood() {//            return true;            return quality < 80;        }    }    public static void main(String[] args) throws InterruptedException {        // æ¨¡ä»¿5ä¸ªå•†å®¶ï¼Œè¿ç»­æä¾›500æ—¥çš„æƒ…å†µ        int k = 0;        for (int day = 0; day < 500; day++) {            int tmpDay = day;            for (int i = 0; i < 5; i++) {                new Thread(() -> new ProviderDeliver2(String.valueOf(tmpDay)).dailyWork(tmpDay)).start();                k++;            }        }        while (k != consumedCount.get()) {            Thread.sleep(10);        }        System.out.println("done");        System.out.println(errorCount.get()); //0        System.out.println(takeBackCount.get()); //        System.out.println(acceptedCount.get()); //        System.out.println(consumedCount.get()); //    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é™æµä¹‹RateLimiter</title>
      <link href="/2016/10/24/RateLimiter/"/>
      <url>/2016/10/24/RateLimiter/</url>
      
        <content type="html"><![CDATA[<blockquote><p>é«˜å¹¶å‘ä¸‰æ¿æ–§,ç¼“å­˜ã€é™çº§å’Œé™æµ</p></blockquote><a id="more"></a><p>è€è¯è¯´å¾—å¥½ï¼Œè¦æƒ³æœåŠ¡å™¨è€å¾—å¥½ï¼Œä¸‰æ¿æ–§ä¸èƒ½å°‘ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹å…¶ä¸­çš„ä¸€æ¿æ–§â€“â€˜é™æµâ€™</p><h1 id="ä»€ä¹ˆæ˜¯é™æµ"><a href="#ä»€ä¹ˆæ˜¯é™æµ" class="headerlink" title="ä»€ä¹ˆæ˜¯é™æµ"></a><em>ä»€ä¹ˆæ˜¯é™æµ</em></h1><p>  ç®€å•æ˜äº†çš„è¯´ï¼Œåœ¨ç³»ç»Ÿå½“ä¸­ï¼Œæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹åº”ç”¨å…·æœ‰å¹¶è¡Œèƒ½åŠ›ä¸Šé™(æ¯”å¦‚æŸäº›å„æ–­è¡Œä¸šæä¾›çš„æ¥å£)ï¼Œä½ å¤šè¯·æ±‚äº†ç›´æ¥ç»™ä½ è¿”å›é”™è¯¯ç ï¼Œè¿˜æœ‰ä¸€äº›å…·ä½“çš„æœåŠ¡ï¼Œæ¯”å¦‚ç§’æ€ç­‰ï¼Œä»…å…è®¸ä¸€å®šçš„é€Ÿç‡æ¥è®¿é—®ç‰¹å®šçš„èµ„æºï¼Œåœ¨è¿™äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œå°±éœ€è¦ç”¨åˆ°é™æµæ¥å®Œæˆè¿™äº›äº‹æƒ…ã€‚</p><p>ä¸€äº›é€šå¸¸çš„caseï¼Œæ¯”å¦‚è¯´é™åˆ¶æ€»å¹¶å‘æ•°(DB)ï¼Œç¬é—´å¹¶å‘æ•°(Nginx limit_conn)ï¼Œé™åˆ¶å¹³å‡é€Ÿç‡(RateLimiter)ç­‰ã€‚è€Œæˆ‘ä»¬ä»Šå¤©æ‰€è¦å…·ä½“è®¨è®ºçš„ï¼Œå°±æ˜¯é™åˆ¶å¹³å‡é€Ÿç‡çš„æ–¹æ³•ã€‚</p><h1 id="ä¸¤å¤§ç®—æ³•"><a href="#ä¸¤å¤§ç®—æ³•" class="headerlink" title="ä¸¤å¤§ç®—æ³•"></a><em>ä¸¤å¤§ç®—æ³•</em></h1><p>  å½“ç„¶ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å…ˆæ¥è®¨è®ºä¸€ä¸‹é™æµçš„ä¸¤å¤§ç®—æ³•ï¼šæ¼æ¡¶ã€ä»¤ç‰Œæ¡¶ã€‚</p><h2 id="æ¼æ¡¶"><a href="#æ¼æ¡¶" class="headerlink" title="æ¼æ¡¶"></a><em>æ¼æ¡¶</em></h2><p><img src="http://oaxbg6rvg.bkt.clouddn.com/waterDrop.png" alt="waterDrop"></p><h2 id="ä»¤ç‰Œæ¡¶"><a href="#ä»¤ç‰Œæ¡¶" class="headerlink" title="ä»¤ç‰Œæ¡¶"></a><em>ä»¤ç‰Œæ¡¶</em></h2><p><img src="http://oaxbg6rvg.bkt.clouddn.com/tokenPackage.png" alt="tokenBarierr"></p><h1 id="ReteLimiter"><a href="#ReteLimiter" class="headerlink" title="ReteLimiter"></a><em>ReteLimiter</em></h1><p>å¥½å•¦,é‚£å°±è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»¤ç‰Œæ¡¶ç®—æ³•çš„å…·ä½“åº”ç”¨,å¼ºå¤§çš„guavaåŒ…çš„RateLimiterå·²ç»å®ç°äº†é™æµ,ä½¿ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•,å¹¶ä¸”å¯ä»¥å…è®¸ä¸€å®šç¨‹åº¦çš„<br>è¯·æ±‚æ¿€å¢,çœ‹èµ·æ¥æ˜¯éå¸¸å¥½çš„ä¸œè¥¿<del>ç®€å•æ¥è¯´,çœ‹æ³¨é‡Šä¸Šæ¥è¯´,æ˜¯é€šè¿‡æ—¶é—´çš„æ¢ç®—æ¥ç­‰ä»·äºä»¤ç‰Œçš„å­˜å‚¨çš„,å…·ä½“çš„å®ç°æ–¹æ³•,çœ‹å…·ä½“çš„ä»£ç å®ç°å§</del></p><pre class="line-numbers language-Java"><code class="language-Java">/* * Copyright (C) 2012 The Guava Authors * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at    å±Œå±Œçš„ï¼Œå…ˆè¯´æ˜ä¸€ä¸‹æ˜¯åŸºäºApache2çš„å“¦ï½ * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package com.google.common.util.concurrent;import com.google.common.annotations.Beta;import com.google.common.annotations.VisibleForTesting;import com.google.common.base.Preconditions;import com.google.common.base.Ticker;import java.util.concurrent.TimeUnit;import javax.annotation.concurrent.ThreadSafe;/** * A rate limiter. Conceptually, a rate limiter distributes permits at a * configurable rate. Each {@link #acquire()} blocks if necessary until a permit is * available, and then takes it. Once acquired, permits need not be released.  å­—é¢æ„æ€ä¸Šæ¥è¯´ï¼ŒrateLimiterå½“ç„¶æ˜¯æŒ‰ç…§ä¸€ä¸ªç»™å®šçš„é€Ÿç‡æ¥è¿›è¡Œæ´¾å‘ä»¤ç‰Œå•¦ï½  æ‰§è¡Œacquire()æ–¹æ³•ï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªä»¤ç‰Œæ˜¯å¯ç”¨çš„ï¼Œç„¶åè·å¾—è¿™ä¸ªä»¤ç‰Œï¼Œä¸€æ—¦ä»¤ç‰Œè¢«è·å¾—!  ä»¤ç‰Œæ˜¯ä¸éœ€è¦è¢« `é‡Šæ”¾` çš„! * <p>Rate limiters are often used to restrict the rate at which some * physical or logical resource is accessed. This is in contrast to {@link * java.util.concurrent.Semaphore} which restricts the number of concurrent * accesses instead of the rate (note though that concurrency and rate are closely related, * e.g. see <a href="http://en.wikipedia.org/wiki/Little's_law">Little's Law</a>).  RateLimiter å¸¸å¸¸è¢«ç”¨æ¥é™åˆ¶æŸäº›èµ„æºçš„è®¿é—®é€Ÿç‡ã€‚ è¿™å’ŒSemaphoreä¸åŒï¼ŒSemaphoreæ˜¯ç”¨æ¥é™åˆ¶  å¹¶å‘æ•°è€Œä¸æ˜¯é€Ÿç‡ï¼Œè¿™ä¸¤è€…è¿˜æ˜¯æœ‰ä¸åŒçš„ã€‚ * <p>A {@code RateLimiter} is defined primarily by the rate at which permits * are issued. Absent additional configuration, permits will be distributed at a * fixed rate, defined in terms of permits per second. Permits will be distributed * smoothly, with the delay between individual permits being adjusted to ensure * that the configured rate is maintained.  å¦‚æœæ²¡æœ‰é¢å¤–çš„é…ç½®ï¼Œä»¤ç‰Œä¼šä»¥å›ºå®šçš„é€Ÿç‡æ´¾å‘ï¼Œè¿™ä¸ªé€Ÿç‡ä»¥æ¯ç§’ä¸ºå•ä½è®¡ç®—ã€‚  ä»¤ç‰Œå°†ä¼šä»¥å¹³æ»‘çš„é€Ÿç‡æ´¾å‘ï¼Œå•ä½ä»¤ç‰Œä¹‹é—´çš„é—´éš”ä¼šè¢«è‰¯å¥½è°ƒé…ä»¥ä¿éšœä¹‹å‰è®¾å®šå¥½çš„é€Ÿç‡ã€‚ * * <p>It is possible to configure a {@code RateLimiter} to have a warmup * period during which time the permits issued each second steadily increases until * it hits the stable rate.  é€šè¿‡é…ç½®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªé¢„çƒ­çš„é˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¸­æ¯ç§’åˆ†å‘çš„ä»¤ç‰Œæ•°å°†ä¼šé€’å¢ç›´åˆ°è¾¾åˆ°è¾¹ç•Œå€¼ä¸ºæ­¢ * * <p>As an example, imagine that we have a list of tasks to execute, but we don't want to * submit more than 2 per second:  ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—éœ€è¦æ‰§è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¸æƒ³æ¯ç§’åŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡è¶…è¿‡2ä¸ªï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·å†™ *<pre>  {@code *  final RateLimiter rateLimiter = RateLimiter.create(2.0); // rate is "2 permits per second" *  void submitTasks(List<Runnable> tasks, Executor executor) { *    for (Runnable task : tasks) { *      rateLimiter.acquire(); // may wait *      executor.execute(task); *    } *  } *}</pre> * * <p>As another example, imagine that we produce a stream of data, and we want to cap it * at 5kb per second. This could be accomplished by requiring a permit per byte, and specifying * a rate of 5000 permits per second:  å¦ä¸€ä¸ªä¾‹å­å°±æ˜¯ï¼Œæƒ³è±¡ä¸€ä¸‹æ­£åœ¨å¤„ç†ä¸€ä¸ªæ•°æ®æµï¼Œç„¶åæˆ‘ä»¬æƒ³æ¯ç§’å¤„ç†5kbã€‚è¿™é‡Œçš„å¤„ç†æ–¹å¼ï¼Œä¸ºæ¯ä¸ªbyteåˆ†é…ä¸€ä¸ªä»¤ç‰Œï¼Œ  å¹¶ä¸”æŒ‡å®šæ¯ç§’æœ‰5000ä¸ªä»¤ç‰Œã€‚ *<pre>  {@code *  final RateLimiter rateLimiter = RateLimiter.create(5000.0); // rate = 5000 permits per second *  void submitPacket(byte[] packet) { *    rateLimiter.acquire(packet.length); *    networkService.send(packet); *  } *}</pre> * * <p>It is important to note that the number of permits requested <i>never</i> * affect the throttling of the request itself (an invocation to {@code acquire(1)} * and an invocation to {@code acquire(1000)} will result in exactly the same throttling, if any), * but it affects the throttling of the <i>next</i> request. I.e., if an expensive task * arrives at an idle RateLimiter, it will be granted immediately, but it is the <i>next</i> * request that will experience extra throttling, thus paying for the cost of the expensive * task.  ä½œè€…æåˆ°äº†å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå½“å‰è¯·æ±‚çš„ä»¤ç‰Œæ•°é‡å¹¶ä¸ä¼šé˜»æ­¢å½“å‰çš„è¯·æ±‚ï¼Œacquire(1)å’Œacquire(1000)ä¼šå¯¼è‡´ç›¸åŒçš„ç»“æœï¼Œ  å¦‚æœå½“å‰çš„è¯·æ±‚æ¶ˆè€—äº†ç‰¹åˆ«å¤šçš„ä»¤ç‰Œï¼Œé‚£ä¹ˆæ˜¯ç”±â€œä¸‹ä¸€ä¸ªè¯·æ±‚"æ¥å¿è¿˜å½“å‰è¿™ä¸ªè¯·æ±‚æ‰€è€—è´¹çš„ä»¤ç‰Œã€‚  è¿™é‡Œæœ‰ç‚¹ç»•ï¼Œå…·ä½“è¿˜æ˜¯çœ‹ä»£ç å§ * * <p>Note: {@code RateLimiter} does not provide fairness guarantees.  å—¯...è¿™å°±æ˜¯ä¸å…¬å¹³çš„ï¼Œå°±åƒè¿™ä¸ªä¸–ç•Œä¸€æ · =ã€‚=   face and embrace it * * @author Dimitris Andreou * @since 13.0 */// TODO(user): switch to nano precision. A natural unit of cost is "bytes", and a micro precision//     would mean a maximum rate of "1MB/s", which might be small in some cases.@ThreadSafe@Beta// wowï¼Œ åŸæ¥è¿™ç©æ„è¿˜åªæ˜¯ä¸ªBetaç‰ˆæœ¬å‘€ï½public abstract class RateLimiter {  /*   * How is the RateLimiter designed, and why?   *   * The primary feature of a RateLimiter is its "stable rate", the maximum rate that   * is should allow at normal conditions. This is enforced by "throttling" incoming   * requests as needed, i.e. compute, for an incoming request, the appropriate throttle time,   * and make the calling thread wait as much.    å¯¹äºRateLimiteræœ€ä¸»è¦çš„ç‰¹æ€§å°±æ˜¯â€œç¨³å®šçš„é€Ÿç‡â€ï¼Œåœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œå…è®¸ä»¥æœ€é«˜çš„é€Ÿç‡è¿›è¡Œè¿ä½œã€‚    åé¢çš„ä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘   *   * The simplest way to maintain a rate of QPS is to keep the timestamp of the last   * granted request, and ensure that (1/QPS) seconds have elapsed since then. For example,   * for a rate of QPS=5 (5 tokens per second), if we ensure that a request isn't granted   * earlier than 200ms after the the last one, then we achieve the intended rate.   * If a request comes and the last request was granted only 100ms ago, then we wait for   * another 100ms. At this rate, serving 15 fresh permits (i.e. for an acquire(15) request)   * naturally takes 3 seconds.    æœ€ç®€å•çš„æ§åˆ¶QPSçš„åŠæ³•,å°±æ˜¯æ§åˆ¶æ—¶é—´æˆ³å˜›,åªè¦ä¿è¯è‡ªä»ä¸Šä¸€æ¬¡å‘é€ä»¤ç‰Œåˆ°ç°åœ¨å·²ç»ç»è¿‡äº†(1/QPS)ç§’å³å¯,é‚£ä¹ˆ    è¿™æ ·å°±ä¿è¯äº†åŸºæœ¬çš„QPS.   * It is important to realize that such a RateLimiter has a very superficial memory   * of the past: it only remembers the last request. What if the RateLimiter was unused for   * a long period of time, then a request arrived and was immediately granted?   * This RateLimiter would immediately forget about that past underutilization. This may   * result in either underutilization or overflow, depending on the real world consequences   * of not using the expected rate.    ä¸Šè¿°åšæ³•è™½ç„¶ç®€å•ç²—æš´,ä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸€ç‚¹,å°±æ˜¯å®ƒâ€œå¯¹äºè¿‡å»çš„è®¤è¯†å¹¶ä¸å……åˆ†â€--å®ƒä»…è®°ä½äº†ä¸Šä¸€æ¬¡çš„è¯·æ±‚,    å¦‚æœRateLimiterå¾ˆä¹…ä¸è¢«ä½¿ç”¨ï¼Œæ–°æ¥äº†ä¸€ä¸ªè¯·æ±‚,å¹¶ä¸”è¿™ä¸ªè¯·æ±‚å¾ˆå¿«ä¼šè·å¾—æŒ‡ä»¤,é‚£ä¹ˆå®ƒæœºä¼š"å¿˜è®°"æ‰ä¹‹å‰çš„ä½ä½¿ç”¨ç‡,    è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜,å…·ä½“å–å†³äºå…·ä½“çš„åœºæ™¯.   * Past underutilization could mean that excess resources are available. Then, the RateLimiter   * should speed up for a while, to take advantage of these resources. This is important   * when the rate is applied to networking (limiting bandwidth), where past underutilization   * typically translates to "almost empty buffers", which can be filled immediately.   è¿‡å»çš„ä½ä½¿ç”¨ç‡æ„å‘³ç€æœ‰å‰©ä½™çš„å¯ç”¨èµ„æº,æ‰€ä»¥RateLimiterå¯ä»¥æé€Ÿ(??? è¿™é‡Œä¸æ¸…æ¥šåº”è¯¥æ€ä¹ˆç¿»è¯‘)æ¥ä½¿ç”¨è¿™äº›èµ„æº,   * On the other hand, past underutilization could mean that "the server responsible for   * handling the request has become less ready for future requests", i.e. its caches become   * stale, and requests become more likely to trigger expensive operations (a more extreme   * case of this example is when a server has just booted, and it is mostly busy with getting   * itself up to speed).    å¦ä¸ªæ–¹é¢è®²,ä½ä½¿ç”¨ç‡æ„å‘³ç€å¤„ç†è¿™äº›è¯·æ±‚çš„æœåŠ¡æœ‰å¯èƒ½è¿˜æ²¡æœ‰å‡†å¤‡å¥½ä½¿ç”¨è¿™äº›è¯·æ±‚,æ¯”å¦‚è¯´å½“æœåŠ¡ä½¿ç”¨åˆ°cacheæ—¶,    é‚£ä¹ˆåœ¨é•¿æ—¶é—´çš„é—´éš”ä¹‹åçš„çªç„¶è¯·æ±‚,æœ‰å¯èƒ½ä¼šé€ æˆcacheçš„å¤§é‡miss,æ›´æç«¯çš„è¯·æ±‚æ˜¯å½“æœåŠ¡åˆšå¯åŠ¨æ—¶.   * To deal with such scenarios, we add an extra dimension, that of "past underutilization",   * modeled by "storedPermits" variable. This variable is zero when there is no   * underutilization, and it can grow up to maxStoredPermits, for sufficiently large   * underutilization. So, the requested permits, by an invocation acquire(permits),   * are served from:   * - stored permits (if available)   * - fresh permits (for any remaining permits)    ä½œè€…ä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„ç»´åº¦æ¥æè¿°è¿‡å»çš„ä½ä½¿ç”¨ç‡, storedPermits    å½“æ–°è¯·æ±‚ä»¤ç‰Œæ—¶,ä»¤ç‰Œä»stored permitså’Œfresh permitsä¸¤ä¸ªåœ°æ–¹è·å¾—   * How this works is best explained with an example:   *   * For a RateLimiter that produces 1 token per second, every second   * that goes by with the RateLimiter being unused, we increase storedPermits by 1.   * Say we leave the RateLimiter unused for 10 seconds (i.e., we expected a request at time   * X, but we are at time X + 10 seconds before a request actually arrives; this is   * also related to the point made in the last paragraph), thus storedPermits   * becomes 10.0 (assuming maxStoredPermits >= 10.0). At that point, a request of acquire(3)   * arrives. We serve this request out of storedPermits, and reduce that to 7.0 (how this is   * translated to throttling time is discussed later). Immediately after, assume that an   * acquire(10) request arriving. We serve the request partly from storedPermits,   * using all the remaining 7.0 permits, and the remaining 3.0, we serve them by fresh permits   * produced by the rate limiter.    storedPermitså…¶å®æ˜¯ä¸€ä¸ªé¢„å¤‡çš„åº“å­˜çš„æ„æ€,å¦‚æœå…¶ä¸­è¿˜æœ‰ä»¤ç‰Œé¢„å­˜,å°±ç›´æ¥å–,å¦‚æœä¸å¤Ÿçš„è¯,ä¸è¶³çš„éƒ¨åˆ†ç”¨fresh    permitsæ¥å¼¥è¡¥    å½“ç„¶,ä½œè€…å°†è¿™äº›è¡¥å¿çš„å…¬å¼éƒ½è½¬æ¢ä¸ºæ—¶é—´ä¸Šçš„è®¡ç®—,è®¡ç®—æ–¹å¼åé¢å†çœ‹   * We already know how much time it takes to serve 3 fresh permits: if the rate is   * "1 token per second", then this will take 3 seconds. But what does it mean to serve 7   * stored permits? As explained above, there is no unique answer. If we are primarily   * interested to deal with underutilization, then we want stored permits to be given out   * /faster/ than fresh ones, because underutilization = free resources for the taking.   * If we are primarily interested to deal with overflow, then stored permits could   * be given out /slower/ than fresh ones. Thus, we require a (different in each case)   * function that translates storedPermits to throtting time.    å…¶å®æ–°è¯·æ±‚3ä¸ªä»¤ç‰Œçš„æ—¶é—´æ˜¯å®¹æ˜“è®¡ç®—çš„,é‚£ä¹ˆé—®é¢˜å°±åœ¨äºå¦‚ä½•è¡¨ç¤º"æä¾›7ä¸ªstored permits"?    ä½œè€…è¯´,    1:å¦‚æœè¦åº”å¯¹çš„ä½ä½¿ç”¨ç‡,é‚£ä¹ˆåœ¨æä¾›stored permitsçš„æ—¶å€™å°±éœ€è¦æ¯”fresh permitsè¦"å¿«"ä¸€äº›,å› ä¸º    å®é™…ä¸Šstored permitså°±æ„å‘³ç€æ˜¯"é—²ç½®çš„èµ„æº",    2:å¦‚æœè¦åº”å¯¹çš„æ˜¯è¿‡é«˜ä½¿ç”¨ç‡,é‚£ä¹ˆstored permitså°±éœ€è¦æ…¢ä¸€äº›    æ‰€ä»¥ä½œè€…requireäº†ä¸€ä¸ªfunctionæ¥å°†storePermitsè½¬åŒ–ä¸ºthrotting time    OK,ä¸‹é¢å°±æ˜¯ç®—æ³•æè¿°,çœ‹ä¸æ‡‚,å…ˆçœ‹ä»£ç ~   * This role is played by storedPermitsToWaitTime(double storedPermits, double permitsToTake).   * The underlying model is a continuous function mapping storedPermits   * (from 0.0 to maxStoredPermits) onto the 1/rate (i.e. intervals) that is effective at the given   * storedPermits. "storedPermits" essentially measure unused time; we spend unused time   * buying/storing permits. Rate is "permits / time", thus "1 / rate = time / permits".   * Thus, "1/rate" (time / permits) times "permits" gives time, i.e., integrals on this   * function (which is what storedPermitsToWaitTime() computes) correspond to minimum intervals   * between subsequent requests, for the specified number of requested permits.   *   * Here is an example of storedPermitsToWaitTime:   * If storedPermits == 10.0, and we want 3 permits, we take them from storedPermits,   * reducing them to 7.0, and compute the throttling for these as a call to   * storedPermitsToWaitTime(storedPermits = 10.0, permitsToTake = 3.0), which will   * evaluate the integral of the function from 7.0 to 10.0.   *   * Using integrals guarantees that the effect of a single acquire(3) is equivalent   * to { acquire(1); acquire(1); acquire(1); }, or { acquire(2); acquire(1); }, etc,   * since the integral of the function in [7.0, 10.0] is equivalent to the sum of the   * integrals of [7.0, 8.0], [8.0, 9.0], [9.0, 10.0] (and so on), no matter   * what the function is. This guarantees that we handle correctly requests of varying weight   * (permits), /no matter/ what the actual function is - so we can tweak the latter freely.   * (The only requirement, obviously, is that we can compute its integrals).   *   * Note well that if, for this function, we chose a horizontal line, at height of exactly   * (1/QPS), then the effect of the function is non-existent: we serve storedPermits at   * exactly the same cost as fresh ones (1/QPS is the cost for each). We use this trick later.   *   * If we pick a function that goes /below/ that horizontal line, it means that we reduce   * the area of the function, thus time. Thus, the RateLimiter becomes /faster/ after a   * period of underutilization. If, on the other hand, we pick a function that   * goes /above/ that horizontal line, then it means that the area (time) is increased,   * thus storedPermits are more costly than fresh permits, thus the RateLimiter becomes   * /slower/ after a period of underutilization.   *   * Last, but not least: consider a RateLimiter with rate of 1 permit per second, currently   * completely unused, and an expensive acquire(100) request comes. It would be nonsensical   * to just wait for 100 seconds, and /then/ start the actual task. Why wait without doing   * anything? A much better approach is to /allow/ the request right away (as if it was an   * acquire(1) request instead), and postpone /subsequent/ requests as needed. In this version,   * we allow starting the task immediately, and postpone by 100 seconds future requests,   * thus we allow for work to get done in the meantime instead of waiting idly.   *   * This has important consequences: it means that the RateLimiter doesn't remember the time   * of the _last_ request, but it remembers the (expected) time of the _next_ request. This   * also enables us to tell immediately (see tryAcquire(timeout)) whether a particular   * timeout is enough to get us to the point of the next scheduling time, since we always   * maintain that. And what we mean by "an unused RateLimiter" is also defined by that   * notion: when we observe that the "expected arrival time of the next request" is actually   * in the past, then the difference (now - past) is the amount of time that the RateLimiter   * was formally unused, and it is that amount of time which we translate to storedPermits.   * (We increase storedPermits with the amount of permits that would have been produced   * in that idle time). So, if rate == 1 permit per second, and arrivals come exactly   * one second after the previous, then storedPermits is _never_ increased -- we would only   * increase it for arrivals _later_ than the expected one second.   */  /**   * Creates a {@code RateLimiter} with the specified stable throughput, given as   * "permits per second" (commonly referred to as <i>QPS</i>, queries per second).   *   * <p>The returned {@code RateLimiter} ensures that on average no more than {@code   * permitsPerSecond} are issued during any given second, with sustained requests   * being smoothly spread over each second. When the incoming request rate exceeds   * {@code permitsPerSecond} the rate limiter will release one permit every {@code   * (1.0 / permitsPerSecond)} seconds. When the rate limiter is unused,   * bursts of up to {@code permitsPerSecond} permits will be allowed, with subsequent   * requests being smoothly limited at the stable rate of {@code permitsPerSecond}.    RateLimiterä¿è¯äº†   * @param permitsPerSecond the rate of the returned {@code RateLimiter}, measured in   *        how many permits become available per second.   */  // TODO(user): "This is equivalent to  //                 {@code createWithCapacity(permitsPerSecond, 1, TimeUnit.SECONDS)}".  public static RateLimiter create(double permitsPerSecond) {    /*       * The default RateLimiter configuration can save the unused permits of up to one second.       * This is to avoid unnecessary stalls in situations like this: A RateLimiter of 1qps,       * and 4 threads, all calling acquire() at these moments:       *       * T0 at 0 seconds       * T1 at 1.05 seconds       * T2 at 2 seconds       * T3 at 3 seconds       *       * Due to the slight delay of T1, T2 would have to sleep till 2.05 seconds,       * and T3 would also have to sleep till 3.05 seconds.     */    return create(SleepingTicker.SYSTEM_TICKER, permitsPerSecond);  }  @VisibleForTesting  static RateLimiter create(SleepingTicker ticker, double permitsPerSecond) {    RateLimiter rateLimiter = new Bursty(ticker, 1.0 /* maxBurstSeconds */);    rateLimiter.setRate(permitsPerSecond);    return rateLimiter;  }  /**   * Creates a {@code RateLimiter} with the specified stable throughput, given as   * "permits per second" (commonly referred to as <i>QPS</i>, queries per second), and a   * <i>warmup period</i>, during which the {@code RateLimiter} smoothly ramps up its rate,   * until it reaches its maximum rate at the end of the period (as long as there are enough   * requests to saturate it). Similarly, if the {@code RateLimiter} is left <i>unused</i> for   * a duration of {@code warmupPeriod}, it will gradually return to its "cold" state,   * i.e. it will go through the same warming up process as when it was first created.   *   * <p>The returned {@code RateLimiter} is intended for cases where the resource that actually   * fulfills the requests (e.g., a remote server) needs "warmup" time, rather than   * being immediately accessed at the stable (maximum) rate.   *   * <p>The returned {@code RateLimiter} starts in a "cold" state (i.e. the warmup period   * will follow), and if it is left unused for long enough, it will return to that state.   *   * @param permitsPerSecond the rate of the returned {@code RateLimiter}, measured in   *        how many permits become available per second   * @param warmupPeriod the duration of the period where the {@code RateLimiter} ramps up its   *        rate, before reaching its stable (maximum) rate   * @param unit the time unit of the warmupPeriod argument   */  public static RateLimiter create(double permitsPerSecond, long warmupPeriod, TimeUnit unit) {    return create(SleepingTicker.SYSTEM_TICKER, permitsPerSecond, warmupPeriod, unit);  }  @VisibleForTesting  static RateLimiter create(      SleepingTicker ticker, double permitsPerSecond, long warmupPeriod, TimeUnit unit) {    RateLimiter rateLimiter = new WarmingUp(ticker, warmupPeriod, unit);    rateLimiter.setRate(permitsPerSecond);    return rateLimiter;  }  @VisibleForTesting  static RateLimiter createWithCapacity(      SleepingTicker ticker, double permitsPerSecond, long maxBurstBuildup, TimeUnit unit) {    double maxBurstSeconds = unit.toNanos(maxBurstBuildup) / 1E+9;    Bursty rateLimiter = new Bursty(ticker, maxBurstSeconds);    rateLimiter.setRate(permitsPerSecond);    return rateLimiter;  }  /**   * The underlying timer; used both to measure elapsed time and sleep as necessary. A separate   * object to facilitate testing.   */  private final SleepingTicker ticker;  /**   * The timestamp when the RateLimiter was created; used to avoid possible overflow/time-wrapping   * errors.   */  private final long offsetNanos;  /**   * The currently stored permits.   */  double storedPermits;  /**   * The maximum number of stored permits.   */  double maxPermits;  /**   * The interval between two unit requests, at our stable rate. E.g., a stable rate of 5 permits   * per second has a stable interval of 200ms.   */  volatile double stableIntervalMicros;  private final Object mutex = new Object();  /**   * The time when the next request (no matter its size) will be granted. After granting a request,   * this is pushed further in the future. Large requests push this further than small requests.   */  private long nextFreeTicketMicros = 0L; // could be either in the past or future  private RateLimiter(SleepingTicker ticker) {    this.ticker = ticker;    this.offsetNanos = ticker.read();  }  /**   * Updates the stable rate of this {@code RateLimiter}, that is, the   * {@code permitsPerSecond} argument provided in the factory method that   * constructed the {@code RateLimiter}. Currently throttled threads will <b>not</b>   * be awakened as a result of this invocation, thus they do not observe the new rate;   * only subsequent requests will.   *   * <p>Note though that, since each request repays (by waiting, if necessary) the cost   * of the <i>previous</i> request, this means that the very next request   * after an invocation to {@code setRate} will not be affected by the new rate;   * it will pay the cost of the previous request, which is in terms of the previous rate.   *   * <p>The behavior of the {@code RateLimiter} is not modified in any other way,   * e.g. if the {@code RateLimiter} was configured with a warmup period of 20 seconds,   * it still has a warmup period of 20 seconds after this method invocation.   *   * @param permitsPerSecond the new stable rate of this {@code RateLimiter}.   */  public final void setRate(double permitsPerSecond) {    Preconditions.checkArgument(permitsPerSecond > 0.0        && !Double.isNaN(permitsPerSecond), "rate must be positive");    synchronized (mutex) {      resync(readSafeMicros());      double stableIntervalMicros = TimeUnit.SECONDS.toMicros(1L) / permitsPerSecond;      this.stableIntervalMicros = stableIntervalMicros;      doSetRate(permitsPerSecond, stableIntervalMicros);    }  }  abstract void doSetRate(double permitsPerSecond, double stableIntervalMicros);  /**   * Returns the stable rate (as {@code permits per seconds}) with which this   * {@code RateLimiter} is configured with. The initial value of this is the same as   * the {@code permitsPerSecond} argument passed in the factory method that produced   * this {@code RateLimiter}, and it is only updated after invocations   * to {@linkplain #setRate}.   */  public final double getRate() {    return TimeUnit.SECONDS.toMicros(1L) / stableIntervalMicros;  }  /**   * Acquires a permit from this {@code RateLimiter}, blocking until the request can be granted.   *   * <p>This method is equivalent to {@code acquire(1)}.   */  public void acquire() {    acquire(1);  }  /**   * Acquires the given number of permits from this {@code RateLimiter}, blocking until the   * request be granted.   *   * @param permits the number of permits to acquire   */  public void acquire(int permits) {    checkPermits(permits);    long microsToWait;    synchronized (mutex) {      microsToWait = reserveNextTicket(permits, readSafeMicros());    }    ticker.sleepMicrosUninterruptibly(microsToWait);  }  /**   * Acquires a permit from this {@code RateLimiter} if it can be obtained   * without exceeding the specified {@code timeout}, or returns {@code false}   * immediately (without waiting) if the permit would not have been granted   * before the timeout expired.   *   * <p>This method is equivalent to {@code tryAcquire(1, timeout, unit)}.   *   * @param timeout the maximum time to wait for the permit   * @param unit the time unit of the timeout argument   * @return {@code true} if the permit was acquired, {@code false} otherwise   */  public boolean tryAcquire(long timeout, TimeUnit unit) {    return tryAcquire(1, timeout, unit);  }  /**   * Acquires permits from this {@link RateLimiter} if it can be acquired immediately without delay.   *   * <p>   * This method is equivalent to {@code tryAcquire(permits, 0, anyUnit)}.   *   * @param permits the number of permits to acquire   * @return {@code true} if the permits were acquired, {@code false} otherwise   * @since 14.0   */  public boolean tryAcquire(int permits) {    return tryAcquire(permits, 0, TimeUnit.MICROSECONDS);  }  /**   * Acquires a permit from this {@link RateLimiter} if it can be acquired immediately without   * delay.   *   * <p>   * This method is equivalent to {@code tryAcquire(1)}.   *   * @return {@code true} if the permit was acquired, {@code false} otherwise   * @since 14.0   */  public boolean tryAcquire() {    return tryAcquire(1, 0, TimeUnit.MICROSECONDS);  }  /**   * Acquires the given number of permits from this {@code RateLimiter} if it can be obtained   * without exceeding the specified {@code timeout}, or returns {@code false}   * immediately (without waiting) if the permits would not have been granted   * before the timeout expired.   *   * @param permits the number of permits to acquire   * @param timeout the maximum time to wait for the permits   * @param unit the time unit of the timeout argument   * @return {@code true} if the permits were acquired, {@code false} otherwise   */  public boolean tryAcquire(int permits, long timeout, TimeUnit unit) {    long timeoutMicros = unit.toMicros(timeout);    checkPermits(permits);    long microsToWait;    synchronized (mutex) {      long nowMicros = readSafeMicros();      if (nextFreeTicketMicros > nowMicros + timeoutMicros) {        return false;      } else {        microsToWait = reserveNextTicket(permits, nowMicros);      }    }    ticker.sleepMicrosUninterruptibly(microsToWait);    return true;  }  private static void checkPermits(int permits) {    Preconditions.checkArgument(permits > 0, "Requested permits must be positive");  }  /**   * Reserves next ticket and returns the wait time that the caller must wait for.   */  private long reserveNextTicket(double requiredPermits, long nowMicros) {    resync(nowMicros);    long microsToNextFreeTicket = nextFreeTicketMicros - nowMicros;    double storedPermitsToSpend = Math.min(requiredPermits, this.storedPermits);    double freshPermits = requiredPermits - storedPermitsToSpend;    long waitMicros = storedPermitsToWaitTime(this.storedPermits, storedPermitsToSpend)        + (long) (freshPermits * stableIntervalMicros);    this.nextFreeTicketMicros = nextFreeTicketMicros + waitMicros;    this.storedPermits -= storedPermitsToSpend;    return microsToNextFreeTicket;  }  /**   * Translates a specified portion of our currently stored permits which we want to   * spend/acquire, into a throttling time. Conceptually, this evaluates the integral   * of the underlying function we use, for the range of   * [(storedPermits - permitsToTake), storedPermits].   *   * This always holds: {@code 0 <= permitsToTake <= storedPermits}   */  abstract long storedPermitsToWaitTime(double storedPermits, double permitsToTake);  private void resync(long nowMicros) {    // if nextFreeTicket is in the past, resync to now    if (nowMicros > nextFreeTicketMicros) {      storedPermits = Math.min(maxPermits,          storedPermits + (nowMicros - nextFreeTicketMicros) / stableIntervalMicros);      nextFreeTicketMicros = nowMicros;    }  }  private long readSafeMicros() {    return TimeUnit.NANOSECONDS.toMicros(ticker.read() - offsetNanos);  }  @Override  public String toString() {    return String.format("RateLimiter[stableRate=%3.1fqps]", 1000000.0 / stableIntervalMicros);  }  /**   * This implements the following function:   *   *          ^ throttling   *          |   * 3*stable +                  /   * interval |                 /.   *  (cold)  |                / .   *          |               /  .   <-- "warmup period" is the area of the trapezoid between   * 2*stable +              /   .       halfPermits and maxPermits   * interval |             /    .   *          |            /     .   *          |           /      .   *   stable +----------/  WARM . }   * interval |          .   UP  . } <-- this rectangle (from 0 to maxPermits, and   *          |          . PERIOD. }     height == stableInterval) defines the cooldown period,   *          |          .       . }     and we want cooldownPeriod == warmupPeriod   *          |---------------------------------> storedPermits   *              (halfPermits) (maxPermits)   *   * Before going into the details of this particular function, let's keep in mind the basics:   * 1) The state of the RateLimiter (storedPermits) is a vertical line in this figure.   * 2) When the RateLimiter is not used, this goes right (up to maxPermits)   * 3) When the RateLimiter is used, this goes left (down to zero), since if we have storedPermits,   *    we serve from those first   * 4) When _unused_, we go right at the same speed (rate)! I.e., if our rate is   *    2 permits per second, and 3 unused seconds pass, we will always save 6 permits   *    (no matter what our initial position was), up to maxPermits.   *    If we invert the rate, we get the "stableInterval" (interval between two requests   *    in a perfectly spaced out sequence of requests of the given rate). Thus, if you   *    want to see "how much time it will take to go from X storedPermits to X+K storedPermits?",   *    the answer is always stableInterval * K. In the same example, for 2 permits per second,   *    stableInterval is 500ms. Thus to go from X storedPermits to X+6 storedPermits, we   *    require 6 * 500ms = 3 seconds.   *   *    In short, the time it takes to move to the right (save K permits) is equal to the   *    rectangle of width == K and height == stableInterval.   * 4) When _used_, the time it takes, as explained in the introductory class note, is   *    equal to the integral of our function, between X permits and X-K permits, assuming   *    we want to spend K saved permits.   *   *    In summary, the time it takes to move to the left (spend K permits), is equal to the   *    area of the function of width == K.   *   * Let's dive into this function now:   *   * When we have storedPermits <= halfPermits (the left portion of the function), then   * we spend them at the exact same rate that   * fresh permits would be generated anyway (that rate is 1/stableInterval). We size   * this area to be equal to _half_ the specified warmup period. Why we need this?   * And why half? We'll explain shortly below (after explaining the second part).   *   * Stored permits that are beyond halfPermits, are mapped to an ascending line, that goes   * from stableInterval to 3 * stableInterval. The average height for that part is   * 2 * stableInterval, and is sized appropriately to have an area _equal_ to the   * specified warmup period. Thus, by point (4) above, it takes "warmupPeriod" amount of time   * to go from maxPermits to halfPermits.   *   * BUT, by point (3) above, it only takes "warmupPeriod / 2" amount of time to return back   * to maxPermits, from halfPermits! (Because the trapezoid has double the area of the rectangle   * of height stableInterval and equivalent width). We decided that the "cooldown period"   * time should be equivalent to "warmup period", thus a fully saturated RateLimiter   * (with zero stored permits, serving only fresh ones) can go to a fully unsaturated   * (with storedPermits == maxPermits) in the same amount of time it takes for a fully   * unsaturated RateLimiter to return to the stableInterval -- which happens in halfPermits,   * since beyond that point, we use a horizontal line of "stableInterval" height, simulating   * the regular rate.   *   * Thus, we have figured all dimensions of this shape, to give all the desired   * properties:   * - the width is warmupPeriod / stableInterval, to make cooldownPeriod == warmupPeriod   * - the slope starts at the middle, and goes from stableInterval to 3*stableInterval so   *   to have halfPermits being spend in double the usual time (half the rate), while their   *   respective rate is steadily ramping up   */  private static class WarmingUp extends RateLimiter {    final long warmupPeriodMicros;    /**     * The slope of the line from the stable interval (when permits == 0), to the cold interval     * (when permits == maxPermits)     */    private double slope;    private double halfPermits;    WarmingUp(SleepingTicker ticker, long warmupPeriod, TimeUnit timeUnit) {      super(ticker);      this.warmupPeriodMicros = timeUnit.toMicros(warmupPeriod);    }    @Override    void doSetRate(double permitsPerSecond, double stableIntervalMicros) {      double oldMaxPermits = maxPermits;      maxPermits = warmupPeriodMicros / stableIntervalMicros;      halfPermits = maxPermits / 2.0;      // Stable interval is x, cold is 3x, so on average it's 2x. Double the time -> halve the rate      double coldIntervalMicros = stableIntervalMicros * 3.0;      slope = (coldIntervalMicros - stableIntervalMicros) / halfPermits;      if (oldMaxPermits == Double.POSITIVE_INFINITY) {        // if we don't special-case this, we would get storedPermits == NaN, below        storedPermits = 0.0;      } else {        storedPermits = (oldMaxPermits == 0.0)            ? maxPermits // initial state is cold            : storedPermits * maxPermits / oldMaxPermits;      }    }    @Override    long storedPermitsToWaitTime(double storedPermits, double permitsToTake) {      double availablePermitsAboveHalf = storedPermits - halfPermits;      long micros = 0;      // measuring the integral on the right part of the function (the climbing line)      if (availablePermitsAboveHalf > 0.0) {        double permitsAboveHalfToTake = Math.min(availablePermitsAboveHalf, permitsToTake);        micros = (long) (permitsAboveHalfToTake * (permitsToTime(availablePermitsAboveHalf)            + permitsToTime(availablePermitsAboveHalf - permitsAboveHalfToTake)) / 2.0);        permitsToTake -= permitsAboveHalfToTake;      }      // measuring the integral on the left part of the function (the horizontal line)      micros += (stableIntervalMicros * permitsToTake);      return micros;    }    private double permitsToTime(double permits) {      return stableIntervalMicros + permits * slope;    }  }  /**   * This implements a "bursty" RateLimiter, where storedPermits are translated to   * zero throttling. The maximum number of permits that can be saved (when the RateLimiter is   * unused) is defined in terms of time, in this sense: if a RateLimiter is 2qps, and this   * time is specified as 10 seconds, we can save up to 2 * 10 = 20 permits.   */  private static class Bursty extends RateLimiter {    /** The work (permits) of how many seconds can be saved up if this RateLimiter is unused? */    final double maxBurstSeconds;    Bursty(SleepingTicker ticker, double maxBurstSeconds) {      super(ticker);      this.maxBurstSeconds = maxBurstSeconds;    }    @Override    void doSetRate(double permitsPerSecond, double stableIntervalMicros) {      double oldMaxPermits = this.maxPermits;      maxPermits = maxBurstSeconds * permitsPerSecond;      storedPermits = (oldMaxPermits == 0.0)          ? 0.0 // initial state          : storedPermits * maxPermits / oldMaxPermits;    }    @Override    long storedPermitsToWaitTime(double storedPermits, double permitsToTake) {      return 0L;    }  }  @VisibleForTesting  static abstract class SleepingTicker extends Ticker {    abstract void sleepMicrosUninterruptibly(long micros);    static final SleepingTicker SYSTEM_TICKER = new SleepingTicker() {      @Override      public long read() {        return systemTicker().read();      }      @Override      public void sleepMicrosUninterruptibly(long micros) {        if (micros > 0) {          Uninterruptibles.sleepUninterruptibly(micros, TimeUnit.MICROSECONDS);        }      }    };  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RateLimiter </tag>
            
            <tag> Server </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MarkDown å†™æ³•ä¹±å¼¹</title>
      <link href="/2016/07/25/MarkDown/"/>
      <url>/2016/07/25/MarkDown/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è¿™æ˜¯è¶…é“¾æ¥å¤‡å¿˜å…¨åœ¨è¿™ä¸Šé¢<br><a href="http://www.appinn.com/markdown/" target="_blank" rel="noopener">MarkDownè¯­æ³•</a></p></blockquote><a id="more"></a><blockquote><p>This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,<br> consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.<br> Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.</p></blockquote><blockquote><p>Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse<br>id sem consectetuer libero luctus adipiscing.</p></blockquote><blockquote><p>æ ‡é¢˜å“¦<br>This is an H1<br>=============</p></blockquote><h2 id="This-is-an-H2"><a href="#This-is-an-H2" class="headerlink" title="This is an H2"></a>This is an H2</h2><p>ç¬¬ä¸€æ¬¡æ¥è¿™è¾¹å†™æ—¥å¿—ï¼Œç®—æ˜¯ç¬¬ä¸€ç¯‡çœŸæ­£æ„ä¹‰ä¸Šçš„ä¸ªäººblogæ—¥å¿—ï¼Œå¥½çš„å¼€å§‹ï¼ŒHello Worldï¼</p><p>Use the <code>printf()</code> function.</p><blockquote><p>ä»¥ä¸‹æ˜¯Javaä»£ç </p></blockquote><pre class="line-numbers language-Java"><code class="language-Java">System.out.println("hello world!");<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><em>è¿™æ˜¯å¾ˆé‡è¦çš„</em></p><ul><li>line_number</li><li>line_two</li><li>æ©ï¼Œè¿™æ˜¯æ˜Ÿå·</li></ul><ul><li>æ©ï¼Œè¿™æ˜¯åŠ å·</li></ul><blockquote><p>åˆ†å‰²ç¬¦</p></blockquote><hr><hr><ol start="2"><li>ç¬¬ä¸€ç‚¹</li><li>ç¬¬äºŒç‚¹</li></ol>]]></content>
      
      
      <categories>
          
          <category> feel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> First </tag>
            
            <tag> Second </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
