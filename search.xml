<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Javaå¸¸ç”¨è¯Šæ–­å·¥å…·</title>
      <link href="/2020/04/16/Java%E5%B8%B8%E7%94%A8%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/"/>
      <url>/2020/04/16/Java%E5%B8%B8%E7%94%A8%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<p>å¼€å‘è¿‡ç¨‹ä¸­å¹³æ—¶ç»å¸¸ç”¨çš„ä¸€äº›å°å·¥å…·</p><a id="more"></a><h1 id="Javaç›¸å…³å‘½ä»¤"><a href="#Javaç›¸å…³å‘½ä»¤" class="headerlink" title="Javaç›¸å…³å‘½ä»¤"></a>Javaç›¸å…³å‘½ä»¤</h1><p>å¸¸ç”¨çš„å‘½ä»¤ï¼š</p><h2 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h2><p>é€šå¸¸æ¥è¯´ï¼Œå¦‚æœå‡ºç°ç¨‹åºå¡æ­»äº†ï¼ˆæ¯”å¦‚restart tomcatçš„æ—¶å€™ï¼‰ï¼Œä¸çŸ¥é“å¡å“ªå„¿äº†ï¼Œå’‹åŠå‘¢ï¼Œç”¨jstackçœ‹ä¸€ä¸‹å“ªä¸ªçº¿ç¨‹åœ¨å¹²äº‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack -l $(pid)</span><br></pre></td></tr></table></figure><h2 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h2><p>è¿™ä¸ªè²Œä¼¼å°±æ˜¯ç”¨æ¥çœ‹gcçš„ã€‚ã€‚å¹³æ—¶ä¸€èˆ¬å…¶ä»–çš„ä¹Ÿéƒ½ç”¨ä¸ä¸Šå•Š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstat [-å‘½ä»¤é€‰é¡¹] [vmid] [é—´éš”æ—¶é—´/æ¯«ç§’] [æŸ¥è¯¢æ¬¡æ•°]</span><br></pre></td></tr></table></figure><h2 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h2><p>åŸºæœ¬ä¸Šï¼Œç”¨åˆ°äº†jmapå°±æ˜¯å†…å­˜æ³„æ¼äº†<br>å¸¸ç”¨å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo $(pid)</span><br></pre></td></tr></table></figure><h2 id="jcmd"><a href="#jcmd" class="headerlink" title="jcmd"></a>jcmd</h2><p>  å‘é€è¯Šæ–­å‘½ä»¤ï¼Œä¼¼ä¹å•¥éƒ½èƒ½å¹²ï¼Œå‘é€helpå‘½ä»¤ï¼Œå¯ä»¥åŸºæœ¬çœ‹ä¸€äº›èƒ½å¹²çš„äº‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd $(pid) help</span><br></pre></td></tr></table></figure><h2 id="jmc"><a href="#jmc" class="headerlink" title="jmc"></a>jmc</h2><p>jmcå…¶å®å°±æœ‰ç‚¹æ„æ€ï¼Œè¯´ç™½äº†æ˜¯ä¸€ä¸ªç‰¹æ€§ï¼Œé…åˆå’Œjfrä½¿ç”¨ï¼Œ</p><h1 id="ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤"><a href="#ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤" class="headerlink" title="ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤"></a>ç³»ç»Ÿç›¸å…³çš„å‘½ä»¤</h1><h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>çœ‹å†…å­˜çš„å¸¸ç”¨å‘½ä»¤ï¼Œçœ‹ä¸€ä¸‹æ€»å†…å­˜ã€å·²ç”¨å†…å­˜ã€ç©ºé—²å†…å­˜ã€å…±äº«å†…å­˜ã€buff/cacheå†…å­˜å’Œå¯ç”¨å†…å­˜çš„å¤§å°<br>ä»¥åŠswapåˆ†åŒºçš„å¤§å°ï¼ˆå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘çš„æœºå™¨ä¸Šswapåˆ†åŒºå¤§å°ä¸º0ï¼Œå°±æ˜¯è¯´ä¸ä¼šäº§ç”Ÿswapï¼Œç›´æ¥OOMï¼Œé¿å…äº§ç”Ÿswapæœºåˆ¶å¸¦æ¥çš„IOç“¶é¢ˆé—®é¢˜ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[kevin@ky1 ~]$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:          3.7Gi       823Mi       360Mi       0.0Ki       2.5Gi       2.6Gi</span><br><span class="line">Swap:            0B          0B          0B</span><br></pre></td></tr></table></figure><h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><p>topå‘½ä»¤ï¼Œé›†å¤§æˆï¼Œä¸å±•å¼€è¯´äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[kevin@ky1 ~]$ top</span><br><span class="line">top - 23:16:12 up 12 days,  4:16,  1 user,  load average: 0.13, 0.04, 0.01</span><br><span class="line">Tasks: 105 total,   1 running, 104 sleeping,   0 stopped,   0 zombie</span><br><span class="line"><span class="meta">%</span><span class="bash">Cpu(s):  0.0 us,  3.2 sy,  0.0 ni, 96.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span></span><br><span class="line">MiB Mem :   3780.8 total,    360.5 free,    823.7 used,   2596.6 buff/cache</span><br><span class="line">MiB Swap:      0.0 total,      0.0 free,      0.0 used.   2691.2 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line"> 3084 root      10 -10  180812  37704  15780 S   6.7   1.0 219:32.13 AliYunDun</span><br><span class="line">    1 root      20   0  178540  10912   8004 S   0.0   0.3   0:12.98 systemd</span><br><span class="line">    2 root      20   0       0      0      0 S   0.0   0.0   0:00.26 kthreadd</span><br><span class="line">    3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp</span><br><span class="line">    4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp</span><br></pre></td></tr></table></figure><h2 id="pmap"><a href="#pmap" class="headerlink" title="pmap"></a>pmap</h2><p>åˆšå¥½åœ¨ç½‘ä¸ŠæŸ¥åˆ°ä¸€ä¸ªç‰¹åˆ«å¥½çš„ä¾‹å­è¿™é‡Œå…¶å®åˆšå¥½é‡åˆ°ä¸€ä¸ªç‰¹åˆ«å¥½çš„ä¾‹å­<br>å¼€å§‹ç”¨NMTå’Œpmapæ¥è¿›è¡Œåˆ†æå†…å­˜çš„åˆ†å¸ƒï¼Œè¿™é‡Œå¯¹äºjvmçš„å†…å­˜ï¼Œå’ŒçœŸæ­£ä¸€ä¸ªè¿›ç¨‹é”å¯¹åº”çš„å®é™…å†…å­˜æ˜¯å¦‚ä½•åˆ†å¸ƒçš„ï¼Œæœ‰ä¸€ä¸ªç‰¹åˆ«æ·±å…¥ç›´è§‚çš„ç†è§£</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªpmapçš„ä¸€ä¸ªåŸºç¡€è¾“å‡ºï¼Œï¼ˆç‰ˆæœ¬ä¸åŒå¯èƒ½è¾“å‡ºä¸ä¸€æ ·ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">START               SIZE     RSS     PSS   DIRTY          SWAP PERM MAPPING</span><br><span class="line">00000000d54aa000  92824K  92824K  92824K  92824K       0K  rw-p   [anon]</span><br><span class="line">00000000daf50000  174784K 174784K 174784K 174784K       0K  rw-p   [anon]</span><br></pre></td></tr></table></figure><p> ç„¶åå¯¹æ¯”ä¸€ä¸‹ NMT çš„è¾“å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd 14179 VM.native_memory detail</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">14179:</span><br><span class="line"></span><br><span class="line">Native Memory Tracking:</span><br><span class="line"></span><br><span class="line">Total: reserved=653853KB, committed=439409KB</span><br><span class="line">-                 Java Heap (reserved=262144KB, committed=262144KB)</span><br><span class="line">                            (mmap: reserved=262144KB, committed=262144KB)</span><br><span class="line"></span><br><span class="line">-                     Class (reserved=82517KB, committed=81725KB)</span><br><span class="line">                            (classes #17828)</span><br><span class="line">                            (malloc=1317KB #26910)</span><br><span class="line">                            (mmap: reserved=81200KB, committed=80408KB)</span><br><span class="line"></span><br><span class="line">-                    Thread (reserved=20559KB, committed=20559KB)</span><br><span class="line">                            (thread #58)</span><br><span class="line">                            (stack: reserved=20388KB, committed=20388KB)</span><br><span class="line">                            (malloc=102KB #292)</span><br><span class="line">                            (arena=69KB #114)</span><br><span class="line"></span><br><span class="line">-                      Code (reserved=255309KB, committed=41657KB)</span><br><span class="line">                            (malloc=5709KB #11730)</span><br><span class="line">                            (mmap: reserved=249600KB, committed=35948KB)</span><br><span class="line"></span><br><span class="line">-                        GC (reserved=1658KB, committed=1658KB)</span><br><span class="line">                            (malloc=798KB #676)</span><br><span class="line">                            (mmap: reserved=860KB, committed=860KB)</span><br><span class="line"></span><br><span class="line">-                  Compiler (reserved=130KB, committed=130KB)</span><br><span class="line">                            (malloc=31KB #357)</span><br><span class="line">                            (arena=99KB #3)</span><br><span class="line"></span><br><span class="line">-                  Internal (reserved=5039KB, committed=5039KB)</span><br><span class="line">                            (malloc=5007KB #20850)</span><br><span class="line">                            (mmap: reserved=32KB, committed=32KB)</span><br><span class="line"></span><br><span class="line">-                    Symbol (reserved=18402KB, committed=18402KB)</span><br><span class="line">                            (malloc=14972KB #221052)</span><br><span class="line">                            (arena=3430KB #1)</span><br><span class="line"></span><br><span class="line">-    Native Memory Tracking (reserved=2269KB, committed=2269KB)</span><br><span class="line">                            (malloc=53KB #1597)</span><br><span class="line">                            (tracking overhead=2216KB)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-               Arena Chunk (reserved=187KB, committed=187KB)</span><br><span class="line">                            (malloc=187KB)</span><br><span class="line"></span><br><span class="line">-                   Unknown (reserved=5640KB, committed=5640KB)</span><br><span class="line">                            (mmap: reserved=5640KB, committed=5640KB)</span><br><span class="line"> . . .</span><br><span class="line">Virtual memory map:</span><br><span class="line"></span><br><span class="line">[0xceb00000 - 0xcec00000] reserved 1024KB for Class from</span><br><span class="line">[0xced00000 - 0xcee00000] reserved 1024KB for Class from</span><br><span class="line">. . .</span><br><span class="line">[0xcf85e000 - 0xcf8af000] reserved and committed 324KB for Thread Stack from</span><br><span class="line">[0xd4eaf000 - 0xd4f00000] reserved and committed 324KB for Thread Stack from</span><br><span class="line">    [0xf687866e] Thread::record_stack_base_and_size()+0x1be</span><br><span class="line">    [0xf68818bf] JavaThread::run()+0x2f</span><br><span class="line">    [0xf67541f9] java_start(Thread*)+0x119</span><br><span class="line">    [0xf7606395] start_thread+0xd5</span><br><span class="line">//******************** æ³¨æ„è¿™é‡Œ</span><br><span class="line">[0xd5a00000 - 0xe5a00000] reserved 262144KB for Java Heap from</span><br><span class="line">//******************** æ³¨æ„è¿™é‡Œ</span><br><span class="line">. . .</span><br><span class="line">[0xe5e00000 - 0xf4e00000] reserved 245760KB for Code from</span><br><span class="line">[0xf737f000 - 0xf7400000] reserved 516KB for GC from</span><br><span class="line">[0xf745d000 - 0xf747d000] reserved 128KB for Unknown from</span><br><span class="line">[0xf7700000 - 0xf7751000] reserved and committed 324KB for Thread Stack from</span><br><span class="line">[0xf7762000 - 0xf776a000] reserved and committed 32KB for Internal from</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸€è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[0xd5a00000 - 0xe5a00000] reserved 262144KB for Java Heap from</span><br></pre></td></tr></table></figure><p> æ‰€åœ¨çš„é‚£ä¸€è¡Œï¼Œè¡¨ç¤ºäº†javaçš„å †å†…å­˜ä»0xd5a00000å¼€å§‹<br>è¾…åŠ©ä¸Šåœ¨linuxå½“ä¸­ï¼Œè¿›ç¨‹çš„å†…å­˜åˆ†å¸ƒå›¾ï¼Œæ¯ä¸€å—å†…å­˜æ˜¯å¦‚ä½•åˆ†é…çš„å°±ä¸€ç›®äº†ç„¶äº†</p><p><img src="/images/java-tools/pmap.png" alt="pmap"><br>ç”¨äºå¯¹æ¯”ï¼Œé™„ä¸Šï¼Œè™šæ‹Ÿå†…å­˜ç©ºé—´åˆ†å¸ƒå›¾ï¼Œ<br><img src="/images/java-tools/memory2.png" alt="memory"><br><img src="/images/java-tools/memory.png" alt="memory"></p><h2 id="vmstat"><a href="#vmstat" class="headerlink" title="vmstat"></a>vmstat</h2><h2 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h2>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤šç‰ˆæœ¬jdkå¸è½½</title>
      <link href="/2020/04/14/%E5%A4%9A%E7%89%88%E6%9C%ACjdk%E5%8D%B8%E8%BD%BD/"/>
      <url>/2020/04/14/%E5%A4%9A%E7%89%88%E6%9C%ACjdk%E5%8D%B8%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨æœºå™¨ä¸Šæœ‰è‡ªå·±å®‰è£…jdkï¼Œåé¢å› ä¸ºæ˜¯centosï¼Œå› ä¸ºå¼€å‘å·¥å…·åŒ…çš„å…³ç³»æ‰€ä»¥åˆå®‰è£…äº†open-jdkï¼Œå¯¼è‡´äº†æ˜¯è¯´åŒæ—¶å­˜åœ¨å¤šä¸ªç‰ˆæœ¬jdkçš„é—®é¢˜ï¼Œ</p><a id="more"></a><p>åœ¨ä½¿ç”¨jmapçš„æ—¶å€™æŠ¥äº†å¦‚ä¸‹é”™è¯¯ï¼ˆä¿¡æ¯æ˜¯ç½‘ä¸ŠæŠ„çš„ï¼Œå¤§è‡´æ˜¯è¿™ä¸ªæ„æ€ï¼‰</p><pre>Exception in thread "main" sun.jvm.hotspot.runtime.VMVersionMismatchException:Supported versions are 1.5.0, 1.5.0_xx. Target VM is 20.6-b01</pre><p>æ‰€ä»¥éœ€è¦åˆ æ‰æœ¬æœºçš„open-sdkï¼Œç»Ÿä¸€æˆoracle-jdkï¼Œå¦‚æœjava -versionå‡ºç°ä»¥ä¸‹æç¤ºï¼Œè¯´æ˜é»˜è®¤ä½¿ç”¨çš„æ˜¯open-jdk</p><pre>java version "1.8.0"OpenJDK  Runtime Environment (build 1.8.0-b09)OpenJDK 64-Bit Server VM (build 1.8.0-b09, mixed mode)</pre><p>æœ€å¥½è¿˜æ˜¯å…ˆå¸è½½æ‰openjdk,åœ¨å®‰è£…Oracleçš„jdk,</p><p>###<br>1.ç¡®å®šJDKçš„ç‰ˆæœ¬ï¼š<br>rpm -qa | grep jdk</p><p>å¯èƒ½çš„ç»“æœæ˜¯ï¼š</p><p>libgcj-4.1.2-42.el5<br>java-1.4.2-gcj-compat-1.4.2.0-40jpp.115</p><p>###<br>2.ç„¶åå¸è½½ï¼š</p><pre><code>yum -y remove java-1.4.2-gcj-compat-1.4.2.0-40jpp.115</code></pre><p>å¸è½½å®Œæˆä»¥åï¼Œå¯ä»¥ç”¨whereis javaæŸ¥çœ‹javaçš„è·¯å¾„ï¼Œ</p><pre>java: /opt/java/jdk1.8.0_141/bin/java /opt/java/jdk1.8.0_141/jre/bin/java</pre><p>è¿™æ—¶å€™å¦‚æœç›´æ¥ç”¨javaï¼Œå¯èƒ½ä¼šæŠ¥é”™è¯´ â€œ/usr/bin/java not foundâ€<br>é€€å‡ºç»ˆç«¯ï¼Œå¹¶ä¸”é‡æ–°æ‰“å¼€ä¸€ä¸ªç»ˆç«¯å³å¯</p>]]></content>
      
      
      
        <tags>
            
            <tag> basic </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Difference Between Redis And Memcache</title>
      <link href="/2020/04/08/Difference-Between-Redis-And-Memcache/"/>
      <url>/2020/04/08/Difference-Between-Redis-And-Memcache/</url>
      
        <content type="html"><![CDATA[<p>è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹Rediså’ŒMemcacheçš„ä¸€äº›å¼‚åŒ</p><a id="more"></a><h1 id="Redis-amp-Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´"><a href="#Redis-amp-Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´" class="headerlink" title="Redis &amp; Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´"></a>Redis &amp; Memcacheï¼Œéƒ½æ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ç³»ç»Ÿï¼Œç²—ç•¥çš„è¯´</h1><ol><li>æ“ä½œä¸Š<br>Redisæ”¯æŒæœåŠ¡ç«¯çš„æ•°æ®æ“ä½œï¼Œï¼ˆæ¯”å¦‚incrï¼‰ï¼Œä½†æ˜¯Memcacheä¸è¡Œï¼Œéœ€è¦å°†å€¼ä»æœåŠ¡å™¨ä¸Šå–ä¸‹æ¥ï¼Œè¿ç®—ï¼Œä¹‹åå†å­˜å›Memcache</li><li>å†…å­˜ä½¿ç”¨ç‡ä¸Š<br>Memcacheçš„å†…å­˜ä½¿ç”¨ç‡æ¯”Redisæ›´ä½ã€‚ï¼ˆå’Œå†…å­˜åˆ†é…ç­–ç•¥ï¼Œå’Œæ•°æ®ç»“æ„æœ‰å…³ï¼‰</li><li>cpuä½¿ç”¨ä¸Š<br>Redisä»…æ”¯æŒå•æ ¸cpuï¼Œä½†æ˜¯Memcacheæ”¯æŒå¤šæ ¸cpu</li></ol><h1 id="å†è¯¦ç»†ç‚¹"><a href="#å†è¯¦ç»†ç‚¹" class="headerlink" title="å†è¯¦ç»†ç‚¹"></a>å†è¯¦ç»†ç‚¹</h1><h2 id="1-Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„"><a href="#1-Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„" class="headerlink" title="1. Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„"></a>1. Redisä½¿ç”¨å¾ˆå¤šçš„è¿™ä¸ªæ•°æ®é›†åˆï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­åˆ—çš„</h2><ul><li>string</li><li>hash</li><li>list</li><li>set</li><li>sorted set<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/RedisDataStructure.png" alt="RedisDataStructure"></li></ul><h2 id="2-å†…å­˜ç®¡ç†æœºåˆ¶"><a href="#2-å†…å­˜ç®¡ç†æœºåˆ¶" class="headerlink" title="2. å†…å­˜ç®¡ç†æœºåˆ¶"></a>2. å†…å­˜ç®¡ç†æœºåˆ¶</h2><p>æ€§èƒ½ï¼š<br>åœ¨redisä¸­ï¼Œå…è®¸å­˜å‚¨çš„å†…å®¹ï¼Œæ¯”å®é™…çš„ç‰©ç†å†…å­˜è¦æ›´å¤§ï¼Œå½“ç‰©ç†å†…å­˜ç”¨å®Œä¹‹åï¼Œå°±ä¼šä½¿ç”¨swapåˆ†åŒºã€‚swapæ“ä½œæ˜æ˜¾ä¼šé€ æˆioé˜»å¡<a href="https://redis.io/topics/virtual-memory" target="_blank" rel="noopener">å…³äºVirtualMachine</a><br>è€Œmemcacheä¸è¡Œï¼Œä»…æ”¯æŒç‰©ç†å†…å­˜æ“ä½œï¼Œæ‰€ä»¥ï¼Œä»çº¯é€Ÿåº¦ä¸Šæ¥è¯´ï¼Œmemcacheçš„æ€§èƒ½è¦æ¯”redisè¦æ›´å¥½ã€‚<br>æœºåˆ¶:<br>memcacheçš„å†…å­˜åˆ†å¸ƒå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶å®ç±»ä¼¼äºlinuxæ–‡ä»¶ç³»ç»Ÿï¼Œå­˜åœ¨ä¸€å®šçš„å†…å­˜æµªè´¹<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/MemcacheMemoryScheme.png" alt="MemcacheMemoryScheme"></p><p>è€Œå…³äºredisçš„å†…å­˜åˆ†é…åˆ™æ˜¯æ ¹æ®åŸºç¡€ç»“æ„æ¥å®šçš„ï¼Œæµªè´¹è¾ƒå°‘ï¼Œä¸è¿‡è¿™æ ·çš„åˆ†é…å®¹æ˜“å‡ºç°å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œå®˜æ–¹æ–‡æ¡£èµ„æºåˆ™è¯¦ç»†å¾—å¤šï¼Œæˆ‘è¿™é‡Œç›´æ¥ç²˜ä¸€ä¸‹å¥½äº†ï¼Œä¸€å…±4ç‚¹</p><ul><li>å½“keyè¢«åˆ é™¤çš„æ—¶å€™ï¼Œredisä¸ä¼šç«‹åˆ»é‡Šæ”¾å†…å­˜ï¼Œå¦‚æœä½¿ç”¨äº†5Gå†…å­˜ï¼Œç„¶åé‡Šæ”¾äº†2Gï¼Œé‚£ä¹ˆå®é™…ä¸Šçš„å ç”¨ä¾ç„¶ä¼šæ˜¯5G</li><li>åŸºäºç¬¬ä¸€ç‚¹ï¼Œéœ€è¦é¢„è§åˆ°å®é™…çš„rediså ç”¨ï¼Œå¦‚æœé«˜å³°æœŸå¯èƒ½ä½¿ç”¨åˆ°10Gï¼Œé‚£ä¹ˆå°±éœ€è¦æå‰é¢„å¤‡10Gçš„å†…å­˜ï¼ˆè²Œä¼¼æ˜¯åºŸè¯ï¼‰</li><li>å¦‚æœç”³è¯·äº†5Gä¹‹åï¼Œé‡Šæ”¾äº†2Gï¼Œä¹‹ååˆéœ€è¦ä½¿ç”¨å†…å­˜ï¼Œé‚£ä¹ˆredisä¼šåŸºæœ¬ä¸Šä¼šé‡å¤ä½¿ç”¨è¿™2Gçš„èµ„æºï¼ˆè²Œä¼¼ä¹Ÿæ˜¯åºŸè¯ï¼‰</li><li>è¿™æ ·çš„è¯ï¼Œç¢ç‰‡ç‡çš„å½“ å³°å€¼/å¹³æ—¶å€¼ æ¯”ç‡è¾ƒé«˜çš„æ—¶å€™ï¼Œç¢ç‰‡ç‡ä¼šæ¯”è¾ƒé«˜<br>å‚è€ƒéƒ¨åˆ†ï¼š<a href="https://redis.io/topics/memory-optimization" target="_blank" rel="noopener">memory-optimization</a></li></ul><h2 id="3-æ•°æ®æŒä¹…åŒ–"><a href="#3-æ•°æ®æŒä¹…åŒ–" class="headerlink" title="3. æ•°æ®æŒä¹…åŒ–"></a>3. æ•°æ®æŒä¹…åŒ–</h2><p>memcacheç®€å•ç²—æš´ï¼Œç›´æ¥ä¸æ”¯æŒ<br>redisæ”¯æŒï¼Œä¸¤ç§æ¨¡å¼ï¼šrdbå¿«ç…§&amp;AOFæ–‡ä»¶</p><h2 id="4-é›†ç¾¤åŒ–ç®¡ç†"><a href="#4-é›†ç¾¤åŒ–ç®¡ç†" class="headerlink" title="4. é›†ç¾¤åŒ–ç®¡ç†"></a>4. é›†ç¾¤åŒ–ç®¡ç†</h2><ul><li>memcacheæœ¬èº«å¯¹äºé›†ç¾¤åŒ–æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå°±æ˜¯è¯´ï¼Œå¯ä»¥å¯åŠ¨å¤šä¸ªmemcacheèŠ‚ç‚¹ï¼Œå®Œäº†åœ¨å®¢æˆ·ç«¯é€šè¿‡ç®—æ³•ï¼Œå°†æ•°æ®hashåˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡clientç«¯çš„å¤„ç†æ¥åšä¸€ä¸ªé›†ç¾¤<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/memcacheCluster.png" alt="MemcacheCluster"></li><li>redisçš„é›†ç¾¤åˆ™å¯ä»¥ç›´æ¥åœ¨æœåŠ¡ç«¯åšå¤„ç†<br><img src="/images/2020-04-08-Difference-Between-Redis-And-Memcache/redisCluster.png" alt="MemcacheCluster"></li></ul>]]></content>
      
      
      <categories>
          
          <category> tech </category>
          
      </categories>
      
      
        <tags>
            
            <tag> In-Memory Data Storage Systems </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019, New Beginning</title>
      <link href="/2019/01/01/hello-world/"/>
      <url>/2019/01/01/hello-world/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/2019-01-01-hello-world/hello-world-tiny.jpeg" alt=""><br>æ²¡å•¥å¥½è¯´çš„ï¼Œç»™æ‚¨åŠˆä¸ªå‰å§</p><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> normal </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è‹¦å‘½ç®¡å®¶ä¹‹å·§è§£è‰è“é£æ³¢</title>
      <link href="/2017/02/19/Stawberry/"/>
      <url>/2017/02/19/Stawberry/</url>
      
        <content type="html"><![CDATA[<p>é˜¿å“²æ˜¯æ‘ä¸œè¾¹çš„å¤§æˆ·ï¼Œä»–æœ‰ä¸€ä¸ªç‰¹åˆ«å‰å®³çš„ç®¡å®¶ï¼Œèƒ½è¯´ä¼šé“ï¼Œæ™ºå•†è¶…äººï¼Œè¯´åˆ°è‰è“é£æ³¢â€¦</p><a id="more"></a><h1 id="äº‹èµ·"><a href="#äº‹èµ·" class="headerlink" title="äº‹èµ·"></a>äº‹èµ·</h1><p>è€çˆ·å¹³æ—¥æ²¡å•¥çˆ±å¥½ï¼Œå¹´å‰ä¸‹è‹æ­æ—¶å€™ç¢°å·§å°äº†ä¸€æ¬¡è‰è“ï¼Œè‡³æ­¤æ¯æ—¥å¿µå¿µä¸å¿˜ï¼Œæ‹›æ¥ç®¡å®¶â€¦</p><h2 id="åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†"><a href="#åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†" class="headerlink" title="åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†"></a>åŸæ¥æ˜¯è€çˆ·å˜´é¦‹äº†</h2><p>  å˜´é¦‹ä¹Ÿæœ‰è®²ç©¶ï¼Œä¸æ˜¯èƒ¡åƒæµ·å–ï¼Œå’±ä»¬è¦æŒç»­æ€§å‘å±•â€¦<br>  è‰è“è¿™ç‰©ä»¶ï¼Œè¿™å¹´ä»£ä¹Ÿæ²¡å†°ç®±ä»€ä¹ˆçš„ï¼Œæœ€æ–°é²œçš„å°±æ˜¯æ¯æ—¥é‡‡æ‘˜ï¼Œè€çˆ·åšçš„é•¿è¿œæ‰“ç®—ï¼Œæ¯æ—¥ä¸€é†’å°±å¯¹è‰è“å¿ƒå¿ƒå¿µå¿µï¼Œæ‰€ä»¥å•Šï¼Œå°±æƒ³è¶Šæ—©è¶Šå¥½ï¼Œæ™šæ¥ä¸€ç‚¹ä¹Ÿæ²¡å…³ç³»ï¼Œä½†æ˜¯å¿…é¡»æ˜¯ä»Šå¤©æ‘˜çš„æ‰è¡Œï¼Œä½†æ˜¯ä¸€å¤©éƒ½æ²¡åƒåˆ°å¥½è‰è“ï¼Œæˆ‘å¯æ˜¯è¦å‘é£™å“¦ï¼<br>  è¿˜æœ‰ï¼Œè¿™è‰è“è™½å¥½ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½è´ªæ¯å“¦â€¦å•Šå‘¸ï¼Œä¸èƒ½å¤šåƒï¼Œæ¯æ—¥ä¸€è¢‹æ˜¯ä¸ºæœ€å¥½ï¼Œä¹‹åæ¥çš„ï¼Œå°±æŠŠä»–ä»¬é€€æ‰å§ï¼</p><h2 id="è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ"><a href="#è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ" class="headerlink" title="è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ"></a>è€çˆ·æƒ³è¦çš„æ˜¯ä»€ä¹ˆ</h2><p>å¯¹äºè€çˆ·çš„æƒ³æ³•ï¼Œç®¡å®¶è‡ªç„¶æ˜¯æ‘¸å¾—é€å½»ï¼Œç¨ä½œç›˜ç®—ï¼Œå°±çŸ¥é“è€çˆ·æƒ³çš„æ˜¯å•¥</p><ol><li>æ¯å¤©éƒ½éœ€è¦æ¶ˆè€—ä¸€æ‰¹è‰è“(å°½æœ€å¤§åŠªåŠ›)</li><li>æ¯å¤©ä»…åƒä¸€æ‰¹è‰è“</li><li>åªåƒå½“æ—¥æœ€æ–°é²œçš„ã€è´¨é‡è¿‡å…³çš„è‰è“ï¼Œè‡³äºæ˜¯è°æä¾›çš„å¹¶ä¸é‡è¦</li><li>å¦‚æœæœ‰å¤šä½™çš„æˆ–è€…ä¸åˆæ ¼çš„è‰è“ï¼Œåˆ™éœ€è¦æŠŠä»–ä»¬å¤„ç†æ‰(é€€è´§)</li></ol><h2 id="å¬é›†å•†å®¶"><a href="#å¬é›†å•†å®¶" class="headerlink" title="å¬é›†å•†å®¶"></a>å¬é›†å•†å®¶</h2><p>ä»»åŠ¡å©å’ä¸‹å»ï¼Œè®©ç®¡å®¶ä¸€æ‰‹æ“åŠï¼Œè€æ¿æå‡ºäº†éœ€æ±‚ï¼Œé‚£ç®¡å®¶å°±åªèƒ½è·‘è·‘è…¿äº†ï½ è¦æ‹¿åˆ°è‰è“ï¼Œé‚£å¾—é¦–å…ˆè”ç³»ä¸€ä¸‹è‰è“ä¾›åº”å•†æ˜¯ä¸ªä»€ä¹ˆæƒ…å†µ</p><p>å‡ æ—¥ä¹‹åï¼Œå¾ˆå¿«å°±æœ‰äº†æ¶ˆæ¯ï¼Œè¿™å‡ å®¶ä¾›åº”å•†ï¼Œå› ä¸ºè‰è“å±äºç°æ‘˜ï¼Œæ¯æ—¥çš„æƒ…å†µéƒ½ä¸ä¸€æ ·ï¼Œä¾›åº”å•†æ¯å¤©é€æ¥éƒ½è´§ç‰©è´¨é‡ä¹Ÿéƒ½å‚å·®ä¸é½ï¼Œéœ€è¦ç®¡å®¶ä¸€ä¸€éªŒè¿‡<br>å¦‚æœè´§ç‰©è´¨é‡ä¸è¡Œï¼Œé‚£ä¹ˆå°±åªèƒ½é€€è´§å•¦ï¼Œåˆæˆ–è€…æˆ‘ä»¬è€çˆ·å½“æ—¥åªèƒ½åƒè¿‡è‰è“äº†ï¼Œé‚£ä¹ˆæŠ±æ­‰ï¼Œä½ è¿™æ‰¹è´§æˆ‘åªèƒ½é€€å•¦ï¼Œè¦æ˜¯ä½ æ¥çš„æ—¶å€™ï¼Œç®¡å®¶è¿˜åœ¨éªŒä¸Šå®¶çš„è´§ï¼Œé‚£ä½ å¯ä»¥ç¢°ç¢°è¿æ°”ï¼Œä¸‡ä¸€ä¸Šå®¶çš„è´§ç‰©ä¸è¿‡å…³å‘¢ï¼Œæ˜¯å§ï½</p><p>ç®€è€Œè¨€ä¹‹ï¼Œå¸‚åœºç«äº‰çœŸæ˜¯æ¿€çƒˆå‘€ï¼</p><p>é‚£ä¹ˆæç‚¼ä¸€ä¸‹ï¼š</p><ol><li>ä¸ä¿è¯æ¯æ—¥éƒ½æœ‰è´§ç‰©</li><li>ä¸ä¿è¯è´§ç‰©çš„è´¨é‡</li><li>ä¸ä¿è¯åˆ°è´§æ—¶é—´</li><li>æ¥å—é€€è´§</li><li>ä¾›åº”å•†åœ¨è´§ç‰©é€åˆ°ä¹‹å‰ï¼Œå¹¶ä¸çŸ¥æ™“è€çˆ·ä»Šæ—¥æ˜¯å¦å·²ç»äº«ç”¨äº†è‰è“</li></ol><p>å—¯ï¼Œä»»æ€§çš„ä¾›åº”å•†æä¾›çš„æœåŠ¡è¿˜çœŸæ˜¯ä¸æ€ä¹ˆå¯é å•Šï¼Œä½†æ˜¯è¿™æ€»éš¾ä¸ä½èªæ˜çš„ç®¡å®¶ï¼Œå’‹ä¸€çœ‹ï¼Œè™½ç„¶æ¯ä¸€å®¶è´§ç‰©æä¾›å•†å¹¶ä¸èƒ½æä¾›å®Œå…¨å¯é çš„æœåŠ¡ï¼Œä½†æ˜¯æˆ‘å¤šå–Šå‡ å®¶ä¸€èµ·ä¸Šï¼Œé‚£ä¹ˆè€çˆ·çš„éœ€æ±‚è¿˜æ˜¯å¯ä»¥å°½é‡æ»¡è¶³çš„å˜›ï¼Œæƒ³åˆ°è¿™é‡Œï¼Œç®¡å®¶å°±è¢«è‡ªå·±çš„èªæ˜æ‰æ™ºé”æŠ˜æœäº†ï¼Œå¿ƒé‡Œè¿˜æœ‰ç‚¹å°æ¿€åŠ¨å‘¢ (à²¡Ï‰à²¡)hiahiahia</p><p>å¿ƒä¸­ä¸€é˜µç›˜ç®—ä¹‹åï¼Œé€šçŸ¥ä¾›åº”å•†ä»¬å¬é›†åˆ°é™¢ä¸­å¼€äº†ä¸€æ¬¡é›†ä½“ä¼šè®®â€¦.</p><h1 id="ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š"><a href="#ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š" class="headerlink" title="ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š"></a>ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™š</h1><p>ä¼—å•†å®¶ï¼Œä»Šæ—¥å°†å¤§å®¶å¬é›†åˆ°æ­¤ï¼Œæ˜¯ä¸ºäº†é€šçŸ¥å„å•†å®¶ä¹‹åå’±ä»¬çš„ç»Ÿä¸€ä¾›è´§æ–¹å¼ï¼Œä¸€æ–¹é¢å°½é‡ä¿è¯è€çˆ·çš„è¦æ±‚ï¼Œä¸€æ–¹é¢å‘¢ï¼Œä¹Ÿæ˜¯å’Œå¤§å®¶æ‰“ä¸ªæ‹›å‘¼ï¼Œå’±ä»¬ä»¥åå°±æŒ‰ç…§è¿™ä¸ªæ³•å­æ¥ï¼Œäº’é€šæœ‰æ— å˜›</p><p>ä¹‹åæ¯æ—¥ï¼Œè‹¥å„ä½è´§ç‰©åˆ°åï¼Œå¯å°†è´§ç‰©å…ˆç½®æ”¾äºé™¢ä¸­ï¼Œç„¶åç”±çŸ¥æ™“æˆ‘ï¼Œå¾…æˆ‘æ¥å¯¹è´§ç‰©è¿›è¡ŒéªŒæ”¶ï¼ŒéªŒæ”¶é€šè¿‡ä¹‹åï¼Œå‘ä½ å‘æ”¾å½“æ—¥æ¬¾é¡¹ã€‚è‹¥é€šçŸ¥æˆ‘æ—¶ï¼Œæˆ‘å·²æ‰¾åˆ°ä¸€æ‰¹æ–°é²œçš„è´§ç‰©ï¼Œé‚£ä¹ˆä½ è´§çš„æ–°é²œç¨‹åº¦ä¸å¦‚ä¸Šå®¶ï¼Œè‡ªç„¶æ˜¯è¾“äº†ï¼Œé‚£ä¹ˆæˆ‘å°±æ— æ³•ç»™ä½ æ¬¾é¡¹ï¼Œåªèƒ½å°†è´§é€€è¿˜ç»™ä½ ã€‚è‹¥æˆ‘è¿˜åœ¨éªŒè´§ï¼Œé‚£ä½ å¯ä»¥å†ç­‰ç­‰ï¼Œè‹¥ä¹‹å‰çš„è´§ç‰©ä¸åˆæ ¼ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç­‰ç­‰ï¼Œè‹¥ä¸Šå®¶çš„è´§ç‰©ä¸ç¬¦åˆè€çˆ·çš„è¦æ±‚ï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥æ¥éªŒä½ çš„è´§å•¦ï½</p><p>å„å•†å®¶è§ç®¡å®¶æå‡ºå¦‚æ­¤å¦¥å–„çš„æ³¨æ„ï¼Œäº‹å°‘ï¼Œä¹Ÿä¸ç”¨å’Œåˆ«å®¶ä¼¤å’Œæ°”ï¼Œä¸€åˆ‡ä¹°å–å…¨å‡­æœ¬äº‹ï¼Œä¸€ä¸ªä¸€ä¸ªä¹Ÿæ‘©æ‹³æ“¦æŒï¼Œçº·çº·è¡¨ç¤ºèµåŒ</p><h1 id="å•æœºç‰ˆ"><a href="#å•æœºç‰ˆ" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h1><p>ä¸€æ®µæ—¶æ—¥ä¹‹åï¼Œè€çˆ·å¦‚æ„¿åƒä¸Šäº†æƒ³è¦çš„è‰è“ğŸ“ï¼Œç®¡å®¶ä¹Ÿå°†æ­¤æ–¹æ³•è®°å½•äº†ä¸‹æ¥ï¼Œä»¥ä¾¿æ”¹è¿›ä¸å­¦ä¹  :)</p><p>å•†å®¶p1ã€p2å±äºé›†åˆP<code>(Provider)</code>ï¼Œå•†å®¶æä¾›çš„æœåŠ¡éƒ½æ˜¯åŒè´¨çš„ï¼Œå¯ä»¥å½’ä¸ºä¸€ç±»ï¼Œåˆ†åˆ«ä¸º</p><ol><li>é€è´§ deliver</li><li>éªŒè´§ validate</li><li>é€€è´§ takeBack</li></ol><p>è€Œç®¡å®¶g<code>(governor)</code>çš„çŠ¶æ€åˆ†ä¸ºå‡ ç§</p><ol><li>å°šæœªéªŒè´§ available</li><li>æ­£åœ¨éªŒè´§ validating</li><li>éªŒè´§ç»“æŸ unavailable</li></ol><p>é‚£ä¹ˆå•†å®¶æ‰€æ‰§è¡Œçš„æ­¥éª¤å¯ä»¥ç”¨å¦‚ä¸‹ä¼ªä»£ç è¡¨ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderDeliver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dailyWork</span><span class="params">(Provider p, Governor g)</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  p.deliver();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (g.unavailable()) &#123;</span><br><span class="line">    p.takeBack();</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (g.validating()) &#123;</span><br><span class="line">    <span class="comment">// simply wait</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (g.available()) &#123;</span><br><span class="line">    p.validate();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    p.takeBack();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åˆ†å¸ƒå¼ç‰ˆ"><a href="#åˆ†å¸ƒå¼ç‰ˆ" class="headerlink" title="åˆ†å¸ƒå¼ç‰ˆ"></a>åˆ†å¸ƒå¼ç‰ˆ</h1><p>å“å‘€ï¼Œè€çˆ·ä¸€é«˜å…´ï¼Œèµé‡‘ç»™å¾—ç‰¹åˆ«é«˜ï¼Œå„è·¯å•†å®¶æ¥è¸µè€Œè‡³ï¼Œç®¡å®¶è¦å¿™ä¸è¿‡æ¥äº†ï¼Œäºæ˜¯å©å’ä¸‹å»å‡ ä¸ªå®¶ä¸ï¼Œåˆ†åˆ«æ¥å¾…å•†æˆ·ï¼Œæ£€æŸ¥ä¾ç„¶ç”±ç®¡å®¶äº²è‡ªæ“ä½œï¼Œä½†å•†æˆ·æ— éœ€ç­‰å¾…ï¼Œä»…éœ€è¦å°†è´§ç‰©æ”¾åœ¨åºœä¸­ï¼Œé€€è´§ç”±å®¶ä¸å®Œæˆï¼Œè€Œå•†æˆ·ä¹Ÿä¸ç›´æ¥ä¸ç®¡å®¶æ¥è§¦ï¼Œç”±å®¶ä¸è´Ÿè´£å•†å®¶å’Œç®¡å®¶ä¹‹é—´çš„æ²Ÿé€šï¼Œç®¡å®¶é€šè¿‡åºœé‚¸ä¸­çš„æ——å¸œè¡¨ç¤ºè‡ªå·±ç›®å‰æ­£åœ¨éªŒè´§ã€ä¼‘æ¯ã€éªŒè´§å®Œæ¯•</p><p>é‚£ä¹ˆæ•´ä½“çš„æµç¨‹ä½œä¸€ä¸‹ç®€å•è½¬æ¢ï¼Œå¯¹å•†æˆ·æ¥è¯´ï¼Œæµç¨‹æ›´åŠ ç®€å•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Created by kevin on 20/02/2017.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Strawberry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicInteger errorCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">static</span> AtomicInteger takeBackCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">static</span> AtomicInteger consumedCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">static</span> AtomicInteger acceptedCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">static</span> Random r = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderDeliver2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Provider p;</span><br><span class="line"></span><br><span class="line">        ProviderDeliver2(String name) &#123;</span><br><span class="line">            <span class="keyword">this</span>.p = <span class="keyword">new</span> Provider(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">dailyWork</span><span class="params">(<span class="keyword">int</span> day)</span> </span>&#123;</span><br><span class="line">            Merchandise m = p.deliver(); <span class="comment">// è¿é€è´§ç‰©</span></span><br><span class="line">            Worker worker = Worker.of(<span class="keyword">this</span>, day); <span class="comment">// éšä¾¿æ‰¾ä¸ªå®¶ä¸ï¼Œå¹¶æŠŠè´§ç‰©äº¤ç»™ä»–</span></span><br><span class="line">            worker.process(m); <span class="comment">//  å®¶ä¸æ¥å¤„ç†è´§ç‰©</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">takeBack</span><span class="params">(Merchandise m)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> res = m.getTime().incrementAndGet();</span><br><span class="line">            <span class="keyword">if</span> (res == <span class="number">1</span>) &#123;</span><br><span class="line">                takeBackCount.incrementAndGet();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"fail! operate "</span> + res );</span><br><span class="line">                errorCount.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Governor g;</span><br><span class="line">        <span class="keyword">private</span> ProviderDeliver2 pd2;</span><br><span class="line"></span><br><span class="line">        Worker(ProviderDeliver2 pd2, Governor g) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pd2 = pd2;</span><br><span class="line">            <span class="keyword">this</span>.g = g;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> Worker <span class="title">of</span><span class="params">(ProviderDeliver2 pd2, <span class="keyword">int</span> day)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Worker(pd2, Governor.getInstance(day));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(Merchandise m)</span> </span>&#123;</span><br><span class="line">            g.validate(<span class="keyword">this</span>, m);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">takeBack</span><span class="params">(Merchandise m)</span> </span>&#123;</span><br><span class="line">            pd2.takeBack(m);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Governor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> AtomicBoolean available = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">private</span> AtomicBoolean validating = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">private</span> Queue&lt;Merchandise&gt; queue = Queues.newConcurrentLinkedQueue();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> date;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer, Governor&gt; MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> Governor <span class="title">getInstance</span><span class="params">(<span class="keyword">int</span> day)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> MAP.computeIfAbsent(day, Governor::<span class="keyword">new</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">available</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> available.get();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Governor</span><span class="params">(<span class="keyword">int</span> date)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.date = date;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">validate</span><span class="params">(Worker worker, Merchandise m)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!available()) &#123;</span><br><span class="line">                    worker.takeBack(m);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.addMerchandise(m);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!validating.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!available()) &#123;</span><br><span class="line">                    cleanAll(worker);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">                    Merchandise item = queue.poll();</span><br><span class="line">                    <span class="keyword">if</span> (available() &amp;&amp; item.isGood()) &#123;</span><br><span class="line">                        available.set(<span class="keyword">false</span>);</span><br><span class="line">                        acceptedCount.incrementAndGet();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        worker.takeBack(item);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                validating.set(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                consumedCount.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanAll</span><span class="params">(Worker worker)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">                Merchandise item = queue.poll();</span><br><span class="line">                worker.takeBack(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">addMerchandise</span><span class="params">(Merchandise m)</span> </span>&#123;</span><br><span class="line">            queue.add(m);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        Provider(String name) &#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Merchandise <span class="title">deliver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Merchandise(<span class="keyword">this</span>.name + System.nanoTime());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Merchandise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> AtomicInteger time = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> quality = r.nextInt(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function">AtomicInteger <span class="title">getTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> time;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Merchandise(String name) &#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            Merchandise that = (Merchandise) o;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> name != <span class="keyword">null</span> ? name.equals(that.name) : that.name == <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name != <span class="keyword">null</span> ? name.hashCode() : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">isGood</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//            return true;</span></span><br><span class="line">            <span class="keyword">return</span> quality &lt; <span class="number">80</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// æ¨¡ä»¿5ä¸ªå•†å®¶ï¼Œè¿ç»­æä¾›500æ—¥çš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> day = <span class="number">0</span>; day &lt; <span class="number">500</span>; day++) &#123;</span><br><span class="line">            <span class="keyword">int</span> tmpDay = day;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">new</span> Thread(() -&gt; <span class="keyword">new</span> ProviderDeliver2(String.valueOf(tmpDay)).dailyWork(tmpDay)).start();</span><br><span class="line">                k++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (k != consumedCount.get()) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"done"</span>);</span><br><span class="line">        System.out.println(errorCount.get()); <span class="comment">//0</span></span><br><span class="line">        System.out.println(takeBackCount.get()); <span class="comment">//</span></span><br><span class="line">        System.out.println(acceptedCount.get()); <span class="comment">//</span></span><br><span class="line">        System.out.println(consumedCount.get()); <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> normal </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é™æµä¹‹RateLimiter</title>
      <link href="/2016/10/24/RateLimiter/"/>
      <url>/2016/10/24/RateLimiter/</url>
      
        <content type="html"><![CDATA[<blockquote><p>é«˜å¹¶å‘ä¸‰æ¿æ–§,ç¼“å­˜ã€é™çº§å’Œé™æµ</p></blockquote><a id="more"></a><p>è€è¯è¯´å¾—å¥½ï¼Œè¦æƒ³æœåŠ¡å™¨è€å¾—å¥½ï¼Œä¸‰æ¿æ–§ä¸èƒ½å°‘ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹å…¶ä¸­çš„ä¸€æ¿æ–§â€“â€˜é™æµâ€™</p><h1 id="ä»€ä¹ˆæ˜¯é™æµ"><a href="#ä»€ä¹ˆæ˜¯é™æµ" class="headerlink" title="ä»€ä¹ˆæ˜¯é™æµ"></a><em>ä»€ä¹ˆæ˜¯é™æµ</em></h1><p>  ç®€å•æ˜äº†çš„è¯´ï¼Œåœ¨ç³»ç»Ÿå½“ä¸­ï¼Œæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹åº”ç”¨å…·æœ‰å¹¶è¡Œèƒ½åŠ›ä¸Šé™(æ¯”å¦‚æŸäº›å„æ–­è¡Œä¸šæä¾›çš„æ¥å£)ï¼Œä½ å¤šè¯·æ±‚äº†ç›´æ¥ç»™ä½ è¿”å›é”™è¯¯ç ï¼Œè¿˜æœ‰ä¸€äº›å…·ä½“çš„æœåŠ¡ï¼Œæ¯”å¦‚ç§’æ€ç­‰ï¼Œä»…å…è®¸ä¸€å®šçš„é€Ÿç‡æ¥è®¿é—®ç‰¹å®šçš„èµ„æºï¼Œåœ¨è¿™äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œå°±éœ€è¦ç”¨åˆ°é™æµæ¥å®Œæˆè¿™äº›äº‹æƒ…ã€‚</p><p>ä¸€äº›é€šå¸¸çš„caseï¼Œæ¯”å¦‚è¯´é™åˆ¶æ€»å¹¶å‘æ•°(DB)ï¼Œç¬é—´å¹¶å‘æ•°(Nginx limit_conn)ï¼Œé™åˆ¶å¹³å‡é€Ÿç‡(RateLimiter)ç­‰ã€‚è€Œæˆ‘ä»¬ä»Šå¤©æ‰€è¦å…·ä½“è®¨è®ºçš„ï¼Œå°±æ˜¯é™åˆ¶å¹³å‡é€Ÿç‡çš„æ–¹æ³•ã€‚</p><h1 id="ä¸¤å¤§ç®—æ³•"><a href="#ä¸¤å¤§ç®—æ³•" class="headerlink" title="ä¸¤å¤§ç®—æ³•"></a><em>ä¸¤å¤§ç®—æ³•</em></h1><p>  å½“ç„¶ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å…ˆæ¥è®¨è®ºä¸€ä¸‹é™æµçš„ä¸¤å¤§ç®—æ³•ï¼šæ¼æ¡¶ã€ä»¤ç‰Œæ¡¶ã€‚</p><h2 id="æ¼æ¡¶"><a href="#æ¼æ¡¶" class="headerlink" title="æ¼æ¡¶"></a><em>æ¼æ¡¶</em></h2><p><img src="http://oaxbg6rvg.bkt.clouddn.com/waterDrop.png" alt="waterDrop"></p><h2 id="ä»¤ç‰Œæ¡¶"><a href="#ä»¤ç‰Œæ¡¶" class="headerlink" title="ä»¤ç‰Œæ¡¶"></a><em>ä»¤ç‰Œæ¡¶</em></h2><p><img src="http://oaxbg6rvg.bkt.clouddn.com/tokenPackage.png" alt="tokenBarierr"></p><h1 id="ReteLimiter"><a href="#ReteLimiter" class="headerlink" title="ReteLimiter"></a><em>ReteLimiter</em></h1><p>å¥½å•¦,é‚£å°±è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»¤ç‰Œæ¡¶ç®—æ³•çš„å…·ä½“åº”ç”¨,å¼ºå¤§çš„guavaåŒ…çš„RateLimiterå·²ç»å®ç°äº†é™æµ,ä½¿ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•,å¹¶ä¸”å¯ä»¥å…è®¸ä¸€å®šç¨‹åº¦çš„<br>è¯·æ±‚æ¿€å¢,çœ‹èµ·æ¥æ˜¯éå¸¸å¥½çš„ä¸œè¥¿<del>ç®€å•æ¥è¯´,çœ‹æ³¨é‡Šä¸Šæ¥è¯´,æ˜¯é€šè¿‡æ—¶é—´çš„æ¢ç®—æ¥ç­‰ä»·äºä»¤ç‰Œçš„å­˜å‚¨çš„,å…·ä½“çš„å®ç°æ–¹æ³•,çœ‹å…·ä½“çš„ä»£ç å®ç°å§</del></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2012 The Guava Authors</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å±Œå±Œçš„ï¼Œå…ˆè¯´æ˜ä¸€ä¸‹æ˜¯åŸºäºApache2çš„å“¦ï½</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.google.common.util.concurrent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.annotations.Beta;</span><br><span class="line"><span class="keyword">import</span> com.google.common.annotations.VisibleForTesting;</span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Preconditions;</span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Ticker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.concurrent.ThreadSafe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A rate limiter. Conceptually, a rate limiter distributes permits at a</span></span><br><span class="line"><span class="comment"> * configurable rate. Each &#123;<span class="doctag">@link</span> #acquire()&#125; blocks if necessary until a permit is</span></span><br><span class="line"><span class="comment"> * available, and then takes it. Once acquired, permits need not be released.</span></span><br><span class="line"><span class="comment">  å­—é¢æ„æ€ä¸Šæ¥è¯´ï¼ŒrateLimiterå½“ç„¶æ˜¯æŒ‰ç…§ä¸€ä¸ªç»™å®šçš„é€Ÿç‡æ¥è¿›è¡Œæ´¾å‘ä»¤ç‰Œå•¦ï½</span></span><br><span class="line"><span class="comment">  æ‰§è¡Œacquire()æ–¹æ³•ï¼Œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªä»¤ç‰Œæ˜¯å¯ç”¨çš„ï¼Œç„¶åè·å¾—è¿™ä¸ªä»¤ç‰Œï¼Œä¸€æ—¦ä»¤ç‰Œè¢«è·å¾—!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  ä»¤ç‰Œæ˜¯ä¸éœ€è¦è¢« `é‡Šæ”¾` çš„!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Rate limiters are often used to restrict the rate at which some</span></span><br><span class="line"><span class="comment"> * physical or logical resource is accessed. This is in contrast to &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * java.util.concurrent.Semaphore&#125; which restricts the number of concurrent</span></span><br><span class="line"><span class="comment"> * accesses instead of the rate (note though that concurrency and rate are closely related,</span></span><br><span class="line"><span class="comment"> * e.g. see &lt;a href="http://en.wikipedia.org/wiki/Little's_law"&gt;Little's Law&lt;/a&gt;).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  RateLimiter å¸¸å¸¸è¢«ç”¨æ¥é™åˆ¶æŸäº›èµ„æºçš„è®¿é—®é€Ÿç‡ã€‚ è¿™å’ŒSemaphoreä¸åŒï¼ŒSemaphoreæ˜¯ç”¨æ¥é™åˆ¶</span></span><br><span class="line"><span class="comment">  å¹¶å‘æ•°è€Œä¸æ˜¯é€Ÿç‡ï¼Œè¿™ä¸¤è€…è¿˜æ˜¯æœ‰ä¸åŒçš„ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * &lt;p&gt;A &#123;<span class="doctag">@code</span> RateLimiter&#125; is defined primarily by the rate at which permits</span></span><br><span class="line"><span class="comment"> * are issued. Absent additional configuration, permits will be distributed at a</span></span><br><span class="line"><span class="comment"> * fixed rate, defined in terms of permits per second. Permits will be distributed</span></span><br><span class="line"><span class="comment"> * smoothly, with the delay between individual permits being adjusted to ensure</span></span><br><span class="line"><span class="comment"> * that the configured rate is maintained.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  å¦‚æœæ²¡æœ‰é¢å¤–çš„é…ç½®ï¼Œä»¤ç‰Œä¼šä»¥å›ºå®šçš„é€Ÿç‡æ´¾å‘ï¼Œè¿™ä¸ªé€Ÿç‡ä»¥æ¯ç§’ä¸ºå•ä½è®¡ç®—ã€‚</span></span><br><span class="line"><span class="comment">  ä»¤ç‰Œå°†ä¼šä»¥å¹³æ»‘çš„é€Ÿç‡æ´¾å‘ï¼Œå•ä½ä»¤ç‰Œä¹‹é—´çš„é—´éš”ä¼šè¢«è‰¯å¥½è°ƒé…ä»¥ä¿éšœä¹‹å‰è®¾å®šå¥½çš„é€Ÿç‡ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;It is possible to configure a &#123;<span class="doctag">@code</span> RateLimiter&#125; to have a warmup</span></span><br><span class="line"><span class="comment"> * period during which time the permits issued each second steadily increases until</span></span><br><span class="line"><span class="comment"> * it hits the stable rate.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  é€šè¿‡é…ç½®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªé¢„çƒ­çš„é˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¸­æ¯ç§’åˆ†å‘çš„ä»¤ç‰Œæ•°å°†ä¼šé€’å¢ç›´åˆ°è¾¾åˆ°è¾¹ç•Œå€¼ä¸ºæ­¢</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As an example, imagine that we have a list of tasks to execute, but we don't want to</span></span><br><span class="line"><span class="comment"> * submit more than 2 per second:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—éœ€è¦æ‰§è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¸æƒ³æ¯ç§’åŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡è¶…è¿‡2ä¸ªï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·å†™</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *&lt;pre&gt;  &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> *  final RateLimiter rateLimiter = RateLimiter.create(2.0); // rate is "2 permits per second"</span></span><br><span class="line"><span class="comment"> *  void submitTasks(List&lt;Runnable&gt; tasks, Executor executor) &#123;</span></span><br><span class="line"><span class="comment"> *    for (Runnable task : tasks) &#123;</span></span><br><span class="line"><span class="comment"> *      rateLimiter.acquire(); // may wait</span></span><br><span class="line"><span class="comment"> *      executor.execute(task);</span></span><br><span class="line"><span class="comment"> *    &#125;</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> *&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As another example, imagine that we produce a stream of data, and we want to cap it</span></span><br><span class="line"><span class="comment"> * at 5kb per second. This could be accomplished by requiring a permit per byte, and specifying</span></span><br><span class="line"><span class="comment"> * a rate of 5000 permits per second:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  å¦ä¸€ä¸ªä¾‹å­å°±æ˜¯ï¼Œæƒ³è±¡ä¸€ä¸‹æ­£åœ¨å¤„ç†ä¸€ä¸ªæ•°æ®æµï¼Œç„¶åæˆ‘ä»¬æƒ³æ¯ç§’å¤„ç†5kbã€‚è¿™é‡Œçš„å¤„ç†æ–¹å¼ï¼Œä¸ºæ¯ä¸ªbyteåˆ†é…ä¸€ä¸ªä»¤ç‰Œï¼Œ</span></span><br><span class="line"><span class="comment">  å¹¶ä¸”æŒ‡å®šæ¯ç§’æœ‰5000ä¸ªä»¤ç‰Œã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *&lt;pre&gt;  &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> *  final RateLimiter rateLimiter = RateLimiter.create(5000.0); // rate = 5000 permits per second</span></span><br><span class="line"><span class="comment"> *  void submitPacket(byte[] packet) &#123;</span></span><br><span class="line"><span class="comment"> *    rateLimiter.acquire(packet.length);</span></span><br><span class="line"><span class="comment"> *    networkService.send(packet);</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> *&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;It is important to note that the number of permits requested &lt;i&gt;never&lt;/i&gt;</span></span><br><span class="line"><span class="comment"> * affect the throttling of the request itself (an invocation to &#123;<span class="doctag">@code</span> acquire(1)&#125;</span></span><br><span class="line"><span class="comment"> * and an invocation to &#123;<span class="doctag">@code</span> acquire(1000)&#125; will result in exactly the same throttling, if any),</span></span><br><span class="line"><span class="comment"> * but it affects the throttling of the &lt;i&gt;next&lt;/i&gt; request. I.e., if an expensive task</span></span><br><span class="line"><span class="comment"> * arrives at an idle RateLimiter, it will be granted immediately, but it is the &lt;i&gt;next&lt;/i&gt;</span></span><br><span class="line"><span class="comment"> * request that will experience extra throttling, thus paying for the cost of the expensive</span></span><br><span class="line"><span class="comment"> * task.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  ä½œè€…æåˆ°äº†å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå½“å‰è¯·æ±‚çš„ä»¤ç‰Œæ•°é‡å¹¶ä¸ä¼šé˜»æ­¢å½“å‰çš„è¯·æ±‚ï¼Œacquire(1)å’Œacquire(1000)ä¼šå¯¼è‡´ç›¸åŒçš„ç»“æœï¼Œ</span></span><br><span class="line"><span class="comment">  å¦‚æœå½“å‰çš„è¯·æ±‚æ¶ˆè€—äº†ç‰¹åˆ«å¤šçš„ä»¤ç‰Œï¼Œé‚£ä¹ˆæ˜¯ç”±â€œä¸‹ä¸€ä¸ªè¯·æ±‚"æ¥å¿è¿˜å½“å‰è¿™ä¸ªè¯·æ±‚æ‰€è€—è´¹çš„ä»¤ç‰Œã€‚</span></span><br><span class="line"><span class="comment">  è¿™é‡Œæœ‰ç‚¹ç»•ï¼Œå…·ä½“è¿˜æ˜¯çœ‹ä»£ç å§</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: &#123;<span class="doctag">@code</span> RateLimiter&#125; does not provide fairness guarantees.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  å—¯...è¿™å°±æ˜¯ä¸å…¬å¹³çš„ï¼Œå°±åƒè¿™ä¸ªä¸–ç•Œä¸€æ · =ã€‚=   face and embrace it</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dimitris Andreou</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 13.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// TODO(user): switch to nano precision. A natural unit of cost is "bytes", and a micro precision</span></span><br><span class="line"><span class="comment">//     would mean a maximum rate of "1MB/s", which might be small in some cases.</span></span><br><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="meta">@Beta</span></span><br><span class="line"><span class="comment">// wowï¼Œ åŸæ¥è¿™ç©æ„è¿˜åªæ˜¯ä¸ªBetaç‰ˆæœ¬å‘€ï½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiter</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * How is the RateLimiter designed, and why?</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The primary feature of a RateLimiter is its "stable rate", the maximum rate that</span></span><br><span class="line"><span class="comment">   * is should allow at normal conditions. This is enforced by "throttling" incoming</span></span><br><span class="line"><span class="comment">   * requests as needed, i.e. compute, for an incoming request, the appropriate throttle time,</span></span><br><span class="line"><span class="comment">   * and make the calling thread wait as much.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å¯¹äºRateLimiteræœ€ä¸»è¦çš„ç‰¹æ€§å°±æ˜¯â€œç¨³å®šçš„é€Ÿç‡â€ï¼Œåœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œå…è®¸ä»¥æœ€é«˜çš„é€Ÿç‡è¿›è¡Œè¿ä½œã€‚</span></span><br><span class="line"><span class="comment">    åé¢çš„ä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The simplest way to maintain a rate of QPS is to keep the timestamp of the last</span></span><br><span class="line"><span class="comment">   * granted request, and ensure that (1/QPS) seconds have elapsed since then. For example,</span></span><br><span class="line"><span class="comment">   * for a rate of QPS=5 (5 tokens per second), if we ensure that a request isn't granted</span></span><br><span class="line"><span class="comment">   * earlier than 200ms after the the last one, then we achieve the intended rate.</span></span><br><span class="line"><span class="comment">   * If a request comes and the last request was granted only 100ms ago, then we wait for</span></span><br><span class="line"><span class="comment">   * another 100ms. At this rate, serving 15 fresh permits (i.e. for an acquire(15) request)</span></span><br><span class="line"><span class="comment">   * naturally takes 3 seconds.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    æœ€ç®€å•çš„æ§åˆ¶QPSçš„åŠæ³•,å°±æ˜¯æ§åˆ¶æ—¶é—´æˆ³å˜›,åªè¦ä¿è¯è‡ªä»ä¸Šä¸€æ¬¡å‘é€ä»¤ç‰Œåˆ°ç°åœ¨å·²ç»ç»è¿‡äº†(1/QPS)ç§’å³å¯,é‚£ä¹ˆ</span></span><br><span class="line"><span class="comment">    è¿™æ ·å°±ä¿è¯äº†åŸºæœ¬çš„QPS.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * It is important to realize that such a RateLimiter has a very superficial memory</span></span><br><span class="line"><span class="comment">   * of the past: it only remembers the last request. What if the RateLimiter was unused for</span></span><br><span class="line"><span class="comment">   * a long period of time, then a request arrived and was immediately granted?</span></span><br><span class="line"><span class="comment">   * This RateLimiter would immediately forget about that past underutilization. This may</span></span><br><span class="line"><span class="comment">   * result in either underutilization or overflow, depending on the real world consequences</span></span><br><span class="line"><span class="comment">   * of not using the expected rate.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ä¸Šè¿°åšæ³•è™½ç„¶ç®€å•ç²—æš´,ä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸€ç‚¹,å°±æ˜¯å®ƒâ€œå¯¹äºè¿‡å»çš„è®¤è¯†å¹¶ä¸å……åˆ†â€--å®ƒä»…è®°ä½äº†ä¸Šä¸€æ¬¡çš„è¯·æ±‚,</span></span><br><span class="line"><span class="comment">    å¦‚æœRateLimiterå¾ˆä¹…ä¸è¢«ä½¿ç”¨ï¼Œæ–°æ¥äº†ä¸€ä¸ªè¯·æ±‚,å¹¶ä¸”è¿™ä¸ªè¯·æ±‚å¾ˆå¿«ä¼šè·å¾—æŒ‡ä»¤,é‚£ä¹ˆå®ƒæœºä¼š"å¿˜è®°"æ‰ä¹‹å‰çš„ä½ä½¿ç”¨ç‡,</span></span><br><span class="line"><span class="comment">    è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜,å…·ä½“å–å†³äºå…·ä½“çš„åœºæ™¯.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * Past underutilization could mean that excess resources are available. Then, the RateLimiter</span></span><br><span class="line"><span class="comment">   * should speed up for a while, to take advantage of these resources. This is important</span></span><br><span class="line"><span class="comment">   * when the rate is applied to networking (limiting bandwidth), where past underutilization</span></span><br><span class="line"><span class="comment">   * typically translates to "almost empty buffers", which can be filled immediately.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   è¿‡å»çš„ä½ä½¿ç”¨ç‡æ„å‘³ç€æœ‰å‰©ä½™çš„å¯ç”¨èµ„æº,æ‰€ä»¥RateLimiterå¯ä»¥æé€Ÿ(??? è¿™é‡Œä¸æ¸…æ¥šåº”è¯¥æ€ä¹ˆç¿»è¯‘)æ¥ä½¿ç”¨è¿™äº›èµ„æº,</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * On the other hand, past underutilization could mean that "the server responsible for</span></span><br><span class="line"><span class="comment">   * handling the request has become less ready for future requests", i.e. its caches become</span></span><br><span class="line"><span class="comment">   * stale, and requests become more likely to trigger expensive operations (a more extreme</span></span><br><span class="line"><span class="comment">   * case of this example is when a server has just booted, and it is mostly busy with getting</span></span><br><span class="line"><span class="comment">   * itself up to speed).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å¦ä¸ªæ–¹é¢è®²,ä½ä½¿ç”¨ç‡æ„å‘³ç€å¤„ç†è¿™äº›è¯·æ±‚çš„æœåŠ¡æœ‰å¯èƒ½è¿˜æ²¡æœ‰å‡†å¤‡å¥½ä½¿ç”¨è¿™äº›è¯·æ±‚,æ¯”å¦‚è¯´å½“æœåŠ¡ä½¿ç”¨åˆ°cacheæ—¶,</span></span><br><span class="line"><span class="comment">    é‚£ä¹ˆåœ¨é•¿æ—¶é—´çš„é—´éš”ä¹‹åçš„çªç„¶è¯·æ±‚,æœ‰å¯èƒ½ä¼šé€ æˆcacheçš„å¤§é‡miss,æ›´æç«¯çš„è¯·æ±‚æ˜¯å½“æœåŠ¡åˆšå¯åŠ¨æ—¶.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * To deal with such scenarios, we add an extra dimension, that of "past underutilization",</span></span><br><span class="line"><span class="comment">   * modeled by "storedPermits" variable. This variable is zero when there is no</span></span><br><span class="line"><span class="comment">   * underutilization, and it can grow up to maxStoredPermits, for sufficiently large</span></span><br><span class="line"><span class="comment">   * underutilization. So, the requested permits, by an invocation acquire(permits),</span></span><br><span class="line"><span class="comment">   * are served from:</span></span><br><span class="line"><span class="comment">   * - stored permits (if available)</span></span><br><span class="line"><span class="comment">   * - fresh permits (for any remaining permits)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ä½œè€…ä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„ç»´åº¦æ¥æè¿°è¿‡å»çš„ä½ä½¿ç”¨ç‡, storedPermits</span></span><br><span class="line"><span class="comment">    å½“æ–°è¯·æ±‚ä»¤ç‰Œæ—¶,ä»¤ç‰Œä»stored permitså’Œfresh permitsä¸¤ä¸ªåœ°æ–¹è·å¾—</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * How this works is best explained with an example:</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * For a RateLimiter that produces 1 token per second, every second</span></span><br><span class="line"><span class="comment">   * that goes by with the RateLimiter being unused, we increase storedPermits by 1.</span></span><br><span class="line"><span class="comment">   * Say we leave the RateLimiter unused for 10 seconds (i.e., we expected a request at time</span></span><br><span class="line"><span class="comment">   * X, but we are at time X + 10 seconds before a request actually arrives; this is</span></span><br><span class="line"><span class="comment">   * also related to the point made in the last paragraph), thus storedPermits</span></span><br><span class="line"><span class="comment">   * becomes 10.0 (assuming maxStoredPermits &gt;= 10.0). At that point, a request of acquire(3)</span></span><br><span class="line"><span class="comment">   * arrives. We serve this request out of storedPermits, and reduce that to 7.0 (how this is</span></span><br><span class="line"><span class="comment">   * translated to throttling time is discussed later). Immediately after, assume that an</span></span><br><span class="line"><span class="comment">   * acquire(10) request arriving. We serve the request partly from storedPermits,</span></span><br><span class="line"><span class="comment">   * using all the remaining 7.0 permits, and the remaining 3.0, we serve them by fresh permits</span></span><br><span class="line"><span class="comment">   * produced by the rate limiter.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    storedPermitså…¶å®æ˜¯ä¸€ä¸ªé¢„å¤‡çš„åº“å­˜çš„æ„æ€,å¦‚æœå…¶ä¸­è¿˜æœ‰ä»¤ç‰Œé¢„å­˜,å°±ç›´æ¥å–,å¦‚æœä¸å¤Ÿçš„è¯,ä¸è¶³çš„éƒ¨åˆ†ç”¨fresh</span></span><br><span class="line"><span class="comment">    permitsæ¥å¼¥è¡¥</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å½“ç„¶,ä½œè€…å°†è¿™äº›è¡¥å¿çš„å…¬å¼éƒ½è½¬æ¢ä¸ºæ—¶é—´ä¸Šçš„è®¡ç®—,è®¡ç®—æ–¹å¼åé¢å†çœ‹</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * We already know how much time it takes to serve 3 fresh permits: if the rate is</span></span><br><span class="line"><span class="comment">   * "1 token per second", then this will take 3 seconds. But what does it mean to serve 7</span></span><br><span class="line"><span class="comment">   * stored permits? As explained above, there is no unique answer. If we are primarily</span></span><br><span class="line"><span class="comment">   * interested to deal with underutilization, then we want stored permits to be given out</span></span><br><span class="line"><span class="comment">   * /faster/ than fresh ones, because underutilization = free resources for the taking.</span></span><br><span class="line"><span class="comment">   * If we are primarily interested to deal with overflow, then stored permits could</span></span><br><span class="line"><span class="comment">   * be given out /slower/ than fresh ones. Thus, we require a (different in each case)</span></span><br><span class="line"><span class="comment">   * function that translates storedPermits to throtting time.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å…¶å®æ–°è¯·æ±‚3ä¸ªä»¤ç‰Œçš„æ—¶é—´æ˜¯å®¹æ˜“è®¡ç®—çš„,é‚£ä¹ˆé—®é¢˜å°±åœ¨äºå¦‚ä½•è¡¨ç¤º"æä¾›7ä¸ªstored permits"?</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ä½œè€…è¯´,</span></span><br><span class="line"><span class="comment">    1:å¦‚æœè¦åº”å¯¹çš„ä½ä½¿ç”¨ç‡,é‚£ä¹ˆåœ¨æä¾›stored permitsçš„æ—¶å€™å°±éœ€è¦æ¯”fresh permitsè¦"å¿«"ä¸€äº›,å› ä¸º</span></span><br><span class="line"><span class="comment">    å®é™…ä¸Šstored permitså°±æ„å‘³ç€æ˜¯"é—²ç½®çš„èµ„æº",</span></span><br><span class="line"><span class="comment">    2:å¦‚æœè¦åº”å¯¹çš„æ˜¯è¿‡é«˜ä½¿ç”¨ç‡,é‚£ä¹ˆstored permitså°±éœ€è¦æ…¢ä¸€äº›</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    æ‰€ä»¥ä½œè€…requireäº†ä¸€ä¸ªfunctionæ¥å°†storePermitsè½¬åŒ–ä¸ºthrotting time</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    OK,ä¸‹é¢å°±æ˜¯ç®—æ³•æè¿°,çœ‹ä¸æ‡‚,å…ˆçœ‹ä»£ç ~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * This role is played by storedPermitsToWaitTime(double storedPermits, double permitsToTake).</span></span><br><span class="line"><span class="comment">   * The underlying model is a continuous function mapping storedPermits</span></span><br><span class="line"><span class="comment">   * (from 0.0 to maxStoredPermits) onto the 1/rate (i.e. intervals) that is effective at the given</span></span><br><span class="line"><span class="comment">   * storedPermits. "storedPermits" essentially measure unused time; we spend unused time</span></span><br><span class="line"><span class="comment">   * buying/storing permits. Rate is "permits / time", thus "1 / rate = time / permits".</span></span><br><span class="line"><span class="comment">   * Thus, "1/rate" (time / permits) times "permits" gives time, i.e., integrals on this</span></span><br><span class="line"><span class="comment">   * function (which is what storedPermitsToWaitTime() computes) correspond to minimum intervals</span></span><br><span class="line"><span class="comment">   * between subsequent requests, for the specified number of requested permits.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Here is an example of storedPermitsToWaitTime:</span></span><br><span class="line"><span class="comment">   * If storedPermits == 10.0, and we want 3 permits, we take them from storedPermits,</span></span><br><span class="line"><span class="comment">   * reducing them to 7.0, and compute the throttling for these as a call to</span></span><br><span class="line"><span class="comment">   * storedPermitsToWaitTime(storedPermits = 10.0, permitsToTake = 3.0), which will</span></span><br><span class="line"><span class="comment">   * evaluate the integral of the function from 7.0 to 10.0.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Using integrals guarantees that the effect of a single acquire(3) is equivalent</span></span><br><span class="line"><span class="comment">   * to &#123; acquire(1); acquire(1); acquire(1); &#125;, or &#123; acquire(2); acquire(1); &#125;, etc,</span></span><br><span class="line"><span class="comment">   * since the integral of the function in [7.0, 10.0] is equivalent to the sum of the</span></span><br><span class="line"><span class="comment">   * integrals of [7.0, 8.0], [8.0, 9.0], [9.0, 10.0] (and so on), no matter</span></span><br><span class="line"><span class="comment">   * what the function is. This guarantees that we handle correctly requests of varying weight</span></span><br><span class="line"><span class="comment">   * (permits), /no matter/ what the actual function is - so we can tweak the latter freely.</span></span><br><span class="line"><span class="comment">   * (The only requirement, obviously, is that we can compute its integrals).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Note well that if, for this function, we chose a horizontal line, at height of exactly</span></span><br><span class="line"><span class="comment">   * (1/QPS), then the effect of the function is non-existent: we serve storedPermits at</span></span><br><span class="line"><span class="comment">   * exactly the same cost as fresh ones (1/QPS is the cost for each). We use this trick later.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * If we pick a function that goes /below/ that horizontal line, it means that we reduce</span></span><br><span class="line"><span class="comment">   * the area of the function, thus time. Thus, the RateLimiter becomes /faster/ after a</span></span><br><span class="line"><span class="comment">   * period of underutilization. If, on the other hand, we pick a function that</span></span><br><span class="line"><span class="comment">   * goes /above/ that horizontal line, then it means that the area (time) is increased,</span></span><br><span class="line"><span class="comment">   * thus storedPermits are more costly than fresh permits, thus the RateLimiter becomes</span></span><br><span class="line"><span class="comment">   * /slower/ after a period of underutilization.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Last, but not least: consider a RateLimiter with rate of 1 permit per second, currently</span></span><br><span class="line"><span class="comment">   * completely unused, and an expensive acquire(100) request comes. It would be nonsensical</span></span><br><span class="line"><span class="comment">   * to just wait for 100 seconds, and /then/ start the actual task. Why wait without doing</span></span><br><span class="line"><span class="comment">   * anything? A much better approach is to /allow/ the request right away (as if it was an</span></span><br><span class="line"><span class="comment">   * acquire(1) request instead), and postpone /subsequent/ requests as needed. In this version,</span></span><br><span class="line"><span class="comment">   * we allow starting the task immediately, and postpone by 100 seconds future requests,</span></span><br><span class="line"><span class="comment">   * thus we allow for work to get done in the meantime instead of waiting idly.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This has important consequences: it means that the RateLimiter doesn't remember the time</span></span><br><span class="line"><span class="comment">   * of the _last_ request, but it remembers the (expected) time of the _next_ request. This</span></span><br><span class="line"><span class="comment">   * also enables us to tell immediately (see tryAcquire(timeout)) whether a particular</span></span><br><span class="line"><span class="comment">   * timeout is enough to get us to the point of the next scheduling time, since we always</span></span><br><span class="line"><span class="comment">   * maintain that. And what we mean by "an unused RateLimiter" is also defined by that</span></span><br><span class="line"><span class="comment">   * notion: when we observe that the "expected arrival time of the next request" is actually</span></span><br><span class="line"><span class="comment">   * in the past, then the difference (now - past) is the amount of time that the RateLimiter</span></span><br><span class="line"><span class="comment">   * was formally unused, and it is that amount of time which we translate to storedPermits.</span></span><br><span class="line"><span class="comment">   * (We increase storedPermits with the amount of permits that would have been produced</span></span><br><span class="line"><span class="comment">   * in that idle time). So, if rate == 1 permit per second, and arrivals come exactly</span></span><br><span class="line"><span class="comment">   * one second after the previous, then storedPermits is _never_ increased -- we would only</span></span><br><span class="line"><span class="comment">   * increase it for arrivals _later_ than the expected one second.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a &#123;<span class="doctag">@code</span> RateLimiter&#125; with the specified stable throughput, given as</span></span><br><span class="line"><span class="comment">   * "permits per second" (commonly referred to as &lt;i&gt;QPS&lt;/i&gt;, queries per second).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;The returned &#123;<span class="doctag">@code</span> RateLimiter&#125; ensures that on average no more than &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">   * permitsPerSecond&#125; are issued during any given second, with sustained requests</span></span><br><span class="line"><span class="comment">   * being smoothly spread over each second. When the incoming request rate exceeds</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@code</span> permitsPerSecond&#125; the rate limiter will release one permit every &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">   * (1.0 / permitsPerSecond)&#125; seconds. When the rate limiter is unused,</span></span><br><span class="line"><span class="comment">   * bursts of up to &#123;<span class="doctag">@code</span> permitsPerSecond&#125; permits will be allowed, with subsequent</span></span><br><span class="line"><span class="comment">   * requests being smoothly limited at the stable rate of &#123;<span class="doctag">@code</span> permitsPerSecond&#125;.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    RateLimiterä¿è¯äº†</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> permitsPerSecond the rate of the returned &#123;<span class="doctag">@code</span> RateLimiter&#125;, measured in</span></span><br><span class="line"><span class="comment">   *        how many permits become available per second.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// TODO(user): "This is equivalent to</span></span><br><span class="line">  <span class="comment">//                 &#123;@code createWithCapacity(permitsPerSecond, 1, TimeUnit.SECONDS)&#125;".</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RateLimiter <span class="title">create</span><span class="params">(<span class="keyword">double</span> permitsPerSecond)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * The default RateLimiter configuration can save the unused permits of up to one second.</span></span><br><span class="line"><span class="comment">       * This is to avoid unnecessary stalls in situations like this: A RateLimiter of 1qps,</span></span><br><span class="line"><span class="comment">       * and 4 threads, all calling acquire() at these moments:</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * T0 at 0 seconds</span></span><br><span class="line"><span class="comment">       * T1 at 1.05 seconds</span></span><br><span class="line"><span class="comment">       * T2 at 2 seconds</span></span><br><span class="line"><span class="comment">       * T3 at 3 seconds</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * Due to the slight delay of T1, T2 would have to sleep till 2.05 seconds,</span></span><br><span class="line"><span class="comment">       * and T3 would also have to sleep till 3.05 seconds.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> create(SleepingTicker.SYSTEM_TICKER, permitsPerSecond);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@VisibleForTesting</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> RateLimiter <span class="title">create</span><span class="params">(SleepingTicker ticker, <span class="keyword">double</span> permitsPerSecond)</span> </span>&#123;</span><br><span class="line">    RateLimiter rateLimiter = <span class="keyword">new</span> Bursty(ticker, <span class="number">1.0</span> <span class="comment">/* maxBurstSeconds */</span>);</span><br><span class="line">    rateLimiter.setRate(permitsPerSecond);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a &#123;<span class="doctag">@code</span> RateLimiter&#125; with the specified stable throughput, given as</span></span><br><span class="line"><span class="comment">   * "permits per second" (commonly referred to as &lt;i&gt;QPS&lt;/i&gt;, queries per second), and a</span></span><br><span class="line"><span class="comment">   * &lt;i&gt;warmup period&lt;/i&gt;, during which the &#123;<span class="doctag">@code</span> RateLimiter&#125; smoothly ramps up its rate,</span></span><br><span class="line"><span class="comment">   * until it reaches its maximum rate at the end of the period (as long as there are enough</span></span><br><span class="line"><span class="comment">   * requests to saturate it). Similarly, if the &#123;<span class="doctag">@code</span> RateLimiter&#125; is left &lt;i&gt;unused&lt;/i&gt; for</span></span><br><span class="line"><span class="comment">   * a duration of &#123;<span class="doctag">@code</span> warmupPeriod&#125;, it will gradually return to its "cold" state,</span></span><br><span class="line"><span class="comment">   * i.e. it will go through the same warming up process as when it was first created.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;The returned &#123;<span class="doctag">@code</span> RateLimiter&#125; is intended for cases where the resource that actually</span></span><br><span class="line"><span class="comment">   * fulfills the requests (e.g., a remote server) needs "warmup" time, rather than</span></span><br><span class="line"><span class="comment">   * being immediately accessed at the stable (maximum) rate.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;The returned &#123;<span class="doctag">@code</span> RateLimiter&#125; starts in a "cold" state (i.e. the warmup period</span></span><br><span class="line"><span class="comment">   * will follow), and if it is left unused for long enough, it will return to that state.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> permitsPerSecond the rate of the returned &#123;<span class="doctag">@code</span> RateLimiter&#125;, measured in</span></span><br><span class="line"><span class="comment">   *        how many permits become available per second</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> warmupPeriod the duration of the period where the &#123;<span class="doctag">@code</span> RateLimiter&#125; ramps up its</span></span><br><span class="line"><span class="comment">   *        rate, before reaching its stable (maximum) rate</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> unit the time unit of the warmupPeriod argument</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RateLimiter <span class="title">create</span><span class="params">(<span class="keyword">double</span> permitsPerSecond, <span class="keyword">long</span> warmupPeriod, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> create(SleepingTicker.SYSTEM_TICKER, permitsPerSecond, warmupPeriod, unit);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@VisibleForTesting</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> RateLimiter <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      SleepingTicker ticker, <span class="keyword">double</span> permitsPerSecond, <span class="keyword">long</span> warmupPeriod, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    RateLimiter rateLimiter = <span class="keyword">new</span> WarmingUp(ticker, warmupPeriod, unit);</span><br><span class="line">    rateLimiter.setRate(permitsPerSecond);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@VisibleForTesting</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> RateLimiter <span class="title">createWithCapacity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      SleepingTicker ticker, <span class="keyword">double</span> permitsPerSecond, <span class="keyword">long</span> maxBurstBuildup, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> maxBurstSeconds = unit.toNanos(maxBurstBuildup) / <span class="number">1E+9</span>;</span><br><span class="line">    Bursty rateLimiter = <span class="keyword">new</span> Bursty(ticker, maxBurstSeconds);</span><br><span class="line">    rateLimiter.setRate(permitsPerSecond);</span><br><span class="line">    <span class="keyword">return</span> rateLimiter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The underlying timer; used both to measure elapsed time and sleep as necessary. A separate</span></span><br><span class="line"><span class="comment">   * object to facilitate testing.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SleepingTicker ticker;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The timestamp when the RateLimiter was created; used to avoid possible overflow/time-wrapping</span></span><br><span class="line"><span class="comment">   * errors.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> offsetNanos;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The currently stored permits.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">double</span> storedPermits;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The maximum number of stored permits.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">double</span> maxPermits;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The interval between two unit requests, at our stable rate. E.g., a stable rate of 5 permits</span></span><br><span class="line"><span class="comment">   * per second has a stable interval of 200ms.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">double</span> stableIntervalMicros;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Object mutex = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The time when the next request (no matter its size) will be granted. After granting a request,</span></span><br><span class="line"><span class="comment">   * this is pushed further in the future. Large requests push this further than small requests.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> nextFreeTicketMicros = <span class="number">0L</span>; <span class="comment">// could be either in the past or future</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">RateLimiter</span><span class="params">(SleepingTicker ticker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.ticker = ticker;</span><br><span class="line">    <span class="keyword">this</span>.offsetNanos = ticker.read();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Updates the stable rate of this &#123;<span class="doctag">@code</span> RateLimiter&#125;, that is, the</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@code</span> permitsPerSecond&#125; argument provided in the factory method that</span></span><br><span class="line"><span class="comment">   * constructed the &#123;<span class="doctag">@code</span> RateLimiter&#125;. Currently throttled threads will &lt;b&gt;not&lt;/b&gt;</span></span><br><span class="line"><span class="comment">   * be awakened as a result of this invocation, thus they do not observe the new rate;</span></span><br><span class="line"><span class="comment">   * only subsequent requests will.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;Note though that, since each request repays (by waiting, if necessary) the cost</span></span><br><span class="line"><span class="comment">   * of the &lt;i&gt;previous&lt;/i&gt; request, this means that the very next request</span></span><br><span class="line"><span class="comment">   * after an invocation to &#123;<span class="doctag">@code</span> setRate&#125; will not be affected by the new rate;</span></span><br><span class="line"><span class="comment">   * it will pay the cost of the previous request, which is in terms of the previous rate.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;The behavior of the &#123;<span class="doctag">@code</span> RateLimiter&#125; is not modified in any other way,</span></span><br><span class="line"><span class="comment">   * e.g. if the &#123;<span class="doctag">@code</span> RateLimiter&#125; was configured with a warmup period of 20 seconds,</span></span><br><span class="line"><span class="comment">   * it still has a warmup period of 20 seconds after this method invocation.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> permitsPerSecond the new stable rate of this &#123;<span class="doctag">@code</span> RateLimiter&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRate</span><span class="params">(<span class="keyword">double</span> permitsPerSecond)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkArgument(permitsPerSecond &gt; <span class="number">0.0</span></span><br><span class="line">        &amp;&amp; !Double.isNaN(permitsPerSecond), <span class="string">"rate must be positive"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">      resync(readSafeMicros());</span><br><span class="line">      <span class="keyword">double</span> stableIntervalMicros = TimeUnit.SECONDS.toMicros(<span class="number">1L</span>) / permitsPerSecond;</span><br><span class="line">      <span class="keyword">this</span>.stableIntervalMicros = stableIntervalMicros;</span><br><span class="line">      doSetRate(permitsPerSecond, stableIntervalMicros);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doSetRate</span><span class="params">(<span class="keyword">double</span> permitsPerSecond, <span class="keyword">double</span> stableIntervalMicros)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the stable rate (as &#123;<span class="doctag">@code</span> permits per seconds&#125;) with which this</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@code</span> RateLimiter&#125; is configured with. The initial value of this is the same as</span></span><br><span class="line"><span class="comment">   * the &#123;<span class="doctag">@code</span> permitsPerSecond&#125; argument passed in the factory method that produced</span></span><br><span class="line"><span class="comment">   * this &#123;<span class="doctag">@code</span> RateLimiter&#125;, and it is only updated after invocations</span></span><br><span class="line"><span class="comment">   * to &#123;<span class="doctag">@linkplain</span> #setRate&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">double</span> <span class="title">getRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> TimeUnit.SECONDS.toMicros(<span class="number">1L</span>) / stableIntervalMicros;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Acquires a permit from this &#123;<span class="doctag">@code</span> RateLimiter&#125;, blocking until the request can be granted.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;This method is equivalent to &#123;<span class="doctag">@code</span> acquire(1)&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Acquires the given number of permits from this &#123;<span class="doctag">@code</span> RateLimiter&#125;, blocking until the</span></span><br><span class="line"><span class="comment">   * request be granted.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> permits the number of permits to acquire</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    checkPermits(permits);</span><br><span class="line">    <span class="keyword">long</span> microsToWait;</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">      microsToWait = reserveNextTicket(permits, readSafeMicros());</span><br><span class="line">    &#125;</span><br><span class="line">    ticker.sleepMicrosUninterruptibly(microsToWait);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Acquires a permit from this &#123;<span class="doctag">@code</span> RateLimiter&#125; if it can be obtained</span></span><br><span class="line"><span class="comment">   * without exceeding the specified &#123;<span class="doctag">@code</span> timeout&#125;, or returns &#123;<span class="doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="comment">   * immediately (without waiting) if the permit would not have been granted</span></span><br><span class="line"><span class="comment">   * before the timeout expired.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;This method is equivalent to &#123;<span class="doctag">@code</span> tryAcquire(1, timeout, unit)&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> timeout the maximum time to wait for the permit</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> unit the time unit of the timeout argument</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the permit was acquired, &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> tryAcquire(<span class="number">1</span>, timeout, unit);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Acquires permits from this &#123;<span class="doctag">@link</span> RateLimiter&#125; if it can be acquired immediately without delay.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * This method is equivalent to &#123;<span class="doctag">@code</span> tryAcquire(permits, 0, anyUnit)&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> permits the number of permits to acquire</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the permits were acquired, &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 14.0</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> tryAcquire(permits, <span class="number">0</span>, TimeUnit.MICROSECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Acquires a permit from this &#123;<span class="doctag">@link</span> RateLimiter&#125; if it can be acquired immediately without</span></span><br><span class="line"><span class="comment">   * delay.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * This method is equivalent to &#123;<span class="doctag">@code</span> tryAcquire(1)&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the permit was acquired, &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 14.0</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> tryAcquire(<span class="number">1</span>, <span class="number">0</span>, TimeUnit.MICROSECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Acquires the given number of permits from this &#123;<span class="doctag">@code</span> RateLimiter&#125; if it can be obtained</span></span><br><span class="line"><span class="comment">   * without exceeding the specified &#123;<span class="doctag">@code</span> timeout&#125;, or returns &#123;<span class="doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="comment">   * immediately (without waiting) if the permits would not have been granted</span></span><br><span class="line"><span class="comment">   * before the timeout expired.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> permits the number of permits to acquire</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> timeout the maximum time to wait for the permits</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> unit the time unit of the timeout argument</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the permits were acquired, &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> timeoutMicros = unit.toMicros(timeout);</span><br><span class="line">    checkPermits(permits);</span><br><span class="line">    <span class="keyword">long</span> microsToWait;</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">      <span class="keyword">long</span> nowMicros = readSafeMicros();</span><br><span class="line">      <span class="keyword">if</span> (nextFreeTicketMicros &gt; nowMicros + timeoutMicros) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        microsToWait = reserveNextTicket(permits, nowMicros);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ticker.sleepMicrosUninterruptibly(microsToWait);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPermits</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkArgument(permits &gt; <span class="number">0</span>, <span class="string">"Requested permits must be positive"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Reserves next ticket and returns the wait time that the caller must wait for.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">reserveNextTicket</span><span class="params">(<span class="keyword">double</span> requiredPermits, <span class="keyword">long</span> nowMicros)</span> </span>&#123;</span><br><span class="line">    resync(nowMicros);</span><br><span class="line">    <span class="keyword">long</span> microsToNextFreeTicket = nextFreeTicketMicros - nowMicros;</span><br><span class="line">    <span class="keyword">double</span> storedPermitsToSpend = Math.min(requiredPermits, <span class="keyword">this</span>.storedPermits);</span><br><span class="line">    <span class="keyword">double</span> freshPermits = requiredPermits - storedPermitsToSpend;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> waitMicros = storedPermitsToWaitTime(<span class="keyword">this</span>.storedPermits, storedPermitsToSpend)</span><br><span class="line">        + (<span class="keyword">long</span>) (freshPermits * stableIntervalMicros);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.nextFreeTicketMicros = nextFreeTicketMicros + waitMicros;</span><br><span class="line">    <span class="keyword">this</span>.storedPermits -= storedPermitsToSpend;</span><br><span class="line">    <span class="keyword">return</span> microsToNextFreeTicket;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Translates a specified portion of our currently stored permits which we want to</span></span><br><span class="line"><span class="comment">   * spend/acquire, into a throttling time. Conceptually, this evaluates the integral</span></span><br><span class="line"><span class="comment">   * of the underlying function we use, for the range of</span></span><br><span class="line"><span class="comment">   * [(storedPermits - permitsToTake), storedPermits].</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This always holds: &#123;<span class="doctag">@code</span> 0 &lt;= permitsToTake &lt;= storedPermits&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">storedPermitsToWaitTime</span><span class="params">(<span class="keyword">double</span> storedPermits, <span class="keyword">double</span> permitsToTake)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resync</span><span class="params">(<span class="keyword">long</span> nowMicros)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// if nextFreeTicket is in the past, resync to now</span></span><br><span class="line">    <span class="keyword">if</span> (nowMicros &gt; nextFreeTicketMicros) &#123;</span><br><span class="line">      storedPermits = Math.min(maxPermits,</span><br><span class="line">          storedPermits + (nowMicros - nextFreeTicketMicros) / stableIntervalMicros);</span><br><span class="line">      nextFreeTicketMicros = nowMicros;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">readSafeMicros</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> TimeUnit.NANOSECONDS.toMicros(ticker.read() - offsetNanos);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">"RateLimiter[stableRate=%3.1fqps]"</span>, <span class="number">1000000.0</span> / stableIntervalMicros);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This implements the following function:</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *          ^ throttling</span></span><br><span class="line"><span class="comment">   *          |</span></span><br><span class="line"><span class="comment">   * 3*stable +                  /</span></span><br><span class="line"><span class="comment">   * interval |                 /.</span></span><br><span class="line"><span class="comment">   *  (cold)  |                / .</span></span><br><span class="line"><span class="comment">   *          |               /  .   &lt;-- "warmup period" is the area of the trapezoid between</span></span><br><span class="line"><span class="comment">   * 2*stable +              /   .       halfPermits and maxPermits</span></span><br><span class="line"><span class="comment">   * interval |             /    .</span></span><br><span class="line"><span class="comment">   *          |            /     .</span></span><br><span class="line"><span class="comment">   *          |           /      .</span></span><br><span class="line"><span class="comment">   *   stable +----------/  WARM . &#125;</span></span><br><span class="line"><span class="comment">   * interval |          .   UP  . &#125; &lt;-- this rectangle (from 0 to maxPermits, and</span></span><br><span class="line"><span class="comment">   *          |          . PERIOD. &#125;     height == stableInterval) defines the cooldown period,</span></span><br><span class="line"><span class="comment">   *          |          .       . &#125;     and we want cooldownPeriod == warmupPeriod</span></span><br><span class="line"><span class="comment">   *          |---------------------------------&gt; storedPermits</span></span><br><span class="line"><span class="comment">   *              (halfPermits) (maxPermits)</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Before going into the details of this particular function, let's keep in mind the basics:</span></span><br><span class="line"><span class="comment">   * 1) The state of the RateLimiter (storedPermits) is a vertical line in this figure.</span></span><br><span class="line"><span class="comment">   * 2) When the RateLimiter is not used, this goes right (up to maxPermits)</span></span><br><span class="line"><span class="comment">   * 3) When the RateLimiter is used, this goes left (down to zero), since if we have storedPermits,</span></span><br><span class="line"><span class="comment">   *    we serve from those first</span></span><br><span class="line"><span class="comment">   * 4) When _unused_, we go right at the same speed (rate)! I.e., if our rate is</span></span><br><span class="line"><span class="comment">   *    2 permits per second, and 3 unused seconds pass, we will always save 6 permits</span></span><br><span class="line"><span class="comment">   *    (no matter what our initial position was), up to maxPermits.</span></span><br><span class="line"><span class="comment">   *    If we invert the rate, we get the "stableInterval" (interval between two requests</span></span><br><span class="line"><span class="comment">   *    in a perfectly spaced out sequence of requests of the given rate). Thus, if you</span></span><br><span class="line"><span class="comment">   *    want to see "how much time it will take to go from X storedPermits to X+K storedPermits?",</span></span><br><span class="line"><span class="comment">   *    the answer is always stableInterval * K. In the same example, for 2 permits per second,</span></span><br><span class="line"><span class="comment">   *    stableInterval is 500ms. Thus to go from X storedPermits to X+6 storedPermits, we</span></span><br><span class="line"><span class="comment">   *    require 6 * 500ms = 3 seconds.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *    In short, the time it takes to move to the right (save K permits) is equal to the</span></span><br><span class="line"><span class="comment">   *    rectangle of width == K and height == stableInterval.</span></span><br><span class="line"><span class="comment">   * 4) When _used_, the time it takes, as explained in the introductory class note, is</span></span><br><span class="line"><span class="comment">   *    equal to the integral of our function, between X permits and X-K permits, assuming</span></span><br><span class="line"><span class="comment">   *    we want to spend K saved permits.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *    In summary, the time it takes to move to the left (spend K permits), is equal to the</span></span><br><span class="line"><span class="comment">   *    area of the function of width == K.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Let's dive into this function now:</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * When we have storedPermits &lt;= halfPermits (the left portion of the function), then</span></span><br><span class="line"><span class="comment">   * we spend them at the exact same rate that</span></span><br><span class="line"><span class="comment">   * fresh permits would be generated anyway (that rate is 1/stableInterval). We size</span></span><br><span class="line"><span class="comment">   * this area to be equal to _half_ the specified warmup period. Why we need this?</span></span><br><span class="line"><span class="comment">   * And why half? We'll explain shortly below (after explaining the second part).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Stored permits that are beyond halfPermits, are mapped to an ascending line, that goes</span></span><br><span class="line"><span class="comment">   * from stableInterval to 3 * stableInterval. The average height for that part is</span></span><br><span class="line"><span class="comment">   * 2 * stableInterval, and is sized appropriately to have an area _equal_ to the</span></span><br><span class="line"><span class="comment">   * specified warmup period. Thus, by point (4) above, it takes "warmupPeriod" amount of time</span></span><br><span class="line"><span class="comment">   * to go from maxPermits to halfPermits.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * BUT, by point (3) above, it only takes "warmupPeriod / 2" amount of time to return back</span></span><br><span class="line"><span class="comment">   * to maxPermits, from halfPermits! (Because the trapezoid has double the area of the rectangle</span></span><br><span class="line"><span class="comment">   * of height stableInterval and equivalent width). We decided that the "cooldown period"</span></span><br><span class="line"><span class="comment">   * time should be equivalent to "warmup period", thus a fully saturated RateLimiter</span></span><br><span class="line"><span class="comment">   * (with zero stored permits, serving only fresh ones) can go to a fully unsaturated</span></span><br><span class="line"><span class="comment">   * (with storedPermits == maxPermits) in the same amount of time it takes for a fully</span></span><br><span class="line"><span class="comment">   * unsaturated RateLimiter to return to the stableInterval -- which happens in halfPermits,</span></span><br><span class="line"><span class="comment">   * since beyond that point, we use a horizontal line of "stableInterval" height, simulating</span></span><br><span class="line"><span class="comment">   * the regular rate.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Thus, we have figured all dimensions of this shape, to give all the desired</span></span><br><span class="line"><span class="comment">   * properties:</span></span><br><span class="line"><span class="comment">   * - the width is warmupPeriod / stableInterval, to make cooldownPeriod == warmupPeriod</span></span><br><span class="line"><span class="comment">   * - the slope starts at the middle, and goes from stableInterval to 3*stableInterval so</span></span><br><span class="line"><span class="comment">   *   to have halfPermits being spend in double the usual time (half the rate), while their</span></span><br><span class="line"><span class="comment">   *   respective rate is steadily ramping up</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WarmingUp</span> <span class="keyword">extends</span> <span class="title">RateLimiter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> warmupPeriodMicros;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The slope of the line from the stable interval (when permits == 0), to the cold interval</span></span><br><span class="line"><span class="comment">     * (when permits == maxPermits)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> slope;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> halfPermits;</span><br><span class="line"></span><br><span class="line">    WarmingUp(SleepingTicker ticker, <span class="keyword">long</span> warmupPeriod, TimeUnit timeUnit) &#123;</span><br><span class="line">      <span class="keyword">super</span>(ticker);</span><br><span class="line">      <span class="keyword">this</span>.warmupPeriodMicros = timeUnit.toMicros(warmupPeriod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doSetRate</span><span class="params">(<span class="keyword">double</span> permitsPerSecond, <span class="keyword">double</span> stableIntervalMicros)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">double</span> oldMaxPermits = maxPermits;</span><br><span class="line">      maxPermits = warmupPeriodMicros / stableIntervalMicros;</span><br><span class="line">      halfPermits = maxPermits / <span class="number">2.0</span>;</span><br><span class="line">      <span class="comment">// Stable interval is x, cold is 3x, so on average it's 2x. Double the time -&gt; halve the rate</span></span><br><span class="line">      <span class="keyword">double</span> coldIntervalMicros = stableIntervalMicros * <span class="number">3.0</span>;</span><br><span class="line">      slope = (coldIntervalMicros - stableIntervalMicros) / halfPermits;</span><br><span class="line">      <span class="keyword">if</span> (oldMaxPermits == Double.POSITIVE_INFINITY) &#123;</span><br><span class="line">        <span class="comment">// if we don't special-case this, we would get storedPermits == NaN, below</span></span><br><span class="line">        storedPermits = <span class="number">0.0</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        storedPermits = (oldMaxPermits == <span class="number">0.0</span>)</span><br><span class="line">            ? maxPermits <span class="comment">// initial state is cold</span></span><br><span class="line">            : storedPermits * maxPermits / oldMaxPermits;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">storedPermitsToWaitTime</span><span class="params">(<span class="keyword">double</span> storedPermits, <span class="keyword">double</span> permitsToTake)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">double</span> availablePermitsAboveHalf = storedPermits - halfPermits;</span><br><span class="line">      <span class="keyword">long</span> micros = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// measuring the integral on the right part of the function (the climbing line)</span></span><br><span class="line">      <span class="keyword">if</span> (availablePermitsAboveHalf &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">        <span class="keyword">double</span> permitsAboveHalfToTake = Math.min(availablePermitsAboveHalf, permitsToTake);</span><br><span class="line">        micros = (<span class="keyword">long</span>) (permitsAboveHalfToTake * (permitsToTime(availablePermitsAboveHalf)</span><br><span class="line">            + permitsToTime(availablePermitsAboveHalf - permitsAboveHalfToTake)) / <span class="number">2.0</span>);</span><br><span class="line">        permitsToTake -= permitsAboveHalfToTake;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// measuring the integral on the left part of the function (the horizontal line)</span></span><br><span class="line">      micros += (stableIntervalMicros * permitsToTake);</span><br><span class="line">      <span class="keyword">return</span> micros;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">permitsToTime</span><span class="params">(<span class="keyword">double</span> permits)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> stableIntervalMicros + permits * slope;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This implements a "bursty" RateLimiter, where storedPermits are translated to</span></span><br><span class="line"><span class="comment">   * zero throttling. The maximum number of permits that can be saved (when the RateLimiter is</span></span><br><span class="line"><span class="comment">   * unused) is defined in terms of time, in this sense: if a RateLimiter is 2qps, and this</span></span><br><span class="line"><span class="comment">   * time is specified as 10 seconds, we can save up to 2 * 10 = 20 permits.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Bursty</span> <span class="keyword">extends</span> <span class="title">RateLimiter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** The work (permits) of how many seconds can be saved up if this RateLimiter is unused? */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">double</span> maxBurstSeconds;</span><br><span class="line"></span><br><span class="line">    Bursty(SleepingTicker ticker, <span class="keyword">double</span> maxBurstSeconds) &#123;</span><br><span class="line">      <span class="keyword">super</span>(ticker);</span><br><span class="line">      <span class="keyword">this</span>.maxBurstSeconds = maxBurstSeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doSetRate</span><span class="params">(<span class="keyword">double</span> permitsPerSecond, <span class="keyword">double</span> stableIntervalMicros)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">double</span> oldMaxPermits = <span class="keyword">this</span>.maxPermits;</span><br><span class="line">      maxPermits = maxBurstSeconds * permitsPerSecond;</span><br><span class="line">      storedPermits = (oldMaxPermits == <span class="number">0.0</span>)</span><br><span class="line">          ? <span class="number">0.0</span> <span class="comment">// initial state</span></span><br><span class="line">          : storedPermits * maxPermits / oldMaxPermits;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">storedPermitsToWaitTime</span><span class="params">(<span class="keyword">double</span> storedPermits, <span class="keyword">double</span> permitsToTake)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@VisibleForTesting</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepingTicker</span> <span class="keyword">extends</span> <span class="title">Ticker</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">sleepMicrosUninterruptibly</span><span class="params">(<span class="keyword">long</span> micros)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> SleepingTicker SYSTEM_TICKER = <span class="keyword">new</span> SleepingTicker() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> systemTicker().read();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleepMicrosUninterruptibly</span><span class="params">(<span class="keyword">long</span> micros)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (micros &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          Uninterruptibles.sleepUninterruptibly(micros, TimeUnit.MICROSECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RateLimiter </tag>
            
            <tag> Server </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MarkDown å†™æ³•ä¹±å¼¹</title>
      <link href="/2016/07/25/MarkDown/"/>
      <url>/2016/07/25/MarkDown/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è¿™æ˜¯è¶…é“¾æ¥å¤‡å¿˜å…¨åœ¨è¿™ä¸Šé¢<br><a href="http://www.appinn.com/markdown/" target="_blank" rel="noopener">MarkDownè¯­æ³•</a></p></blockquote><a id="more"></a><blockquote><p>This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,<br> consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.<br> Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.</p></blockquote><blockquote><p>Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse<br>id sem consectetuer libero luctus adipiscing.</p></blockquote><blockquote><p>æ ‡é¢˜å“¦<br>This is an H1<br>=============</p></blockquote><h2 id="This-is-an-H2"><a href="#This-is-an-H2" class="headerlink" title="This is an H2"></a>This is an H2</h2><p>ç¬¬ä¸€æ¬¡æ¥è¿™è¾¹å†™æ—¥å¿—ï¼Œç®—æ˜¯ç¬¬ä¸€ç¯‡çœŸæ­£æ„ä¹‰ä¸Šçš„ä¸ªäººblogæ—¥å¿—ï¼Œå¥½çš„å¼€å§‹ï¼ŒHello Worldï¼</p><p>Use the <code>printf()</code> function.</p><blockquote><p>ä»¥ä¸‹æ˜¯Javaä»£ç </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"hello world!"</span>);</span><br></pre></td></tr></table></figure><p><em>è¿™æ˜¯å¾ˆé‡è¦çš„</em></p><ul><li>line_number</li><li>line_two</li><li>æ©ï¼Œè¿™æ˜¯æ˜Ÿå·</li></ul><ul><li>æ©ï¼Œè¿™æ˜¯åŠ å·</li></ul><blockquote><p>åˆ†å‰²ç¬¦</p></blockquote><hr><hr><ol start="2"><li>ç¬¬ä¸€ç‚¹</li><li>ç¬¬äºŒç‚¹</li></ol>]]></content>
      
      
      <categories>
          
          <category> feel </category>
          
      </categories>
      
      
        <tags>
            
            <tag> First </tag>
            
            <tag> Second </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
